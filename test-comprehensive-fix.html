<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">
            <i class="fas fa-wrench text-green-600 mr-3"></i>
            Comprehensive System Test & Fix Verification
        </h1>
        
        <!-- Status Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">System Status</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Authentication</div>
                    <div id="auth-status" class="font-semibold mt-1">Checking...</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">API Connection</div>
                    <div id="api-status" class="font-semibold mt-1">Checking...</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Data Access</div>
                    <div id="data-status" class="font-semibold mt-1">Checking...</div>
                </div>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="grid grid-cols-2 gap-6">
            <!-- Authentication Tests -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-lock mr-2"></i>Authentication Tests
                </h3>
                <div id="auth-tests" class="space-y-2"></div>
            </div>
            
            <!-- API Tests -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-server mr-2"></i>API Tests
                </h3>
                <div id="api-tests" class="space-y-2"></div>
            </div>
            
            <!-- UI Tests -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-desktop mr-2"></i>UI Component Tests
                </h3>
                <div id="ui-tests" class="space-y-2"></div>
            </div>
            
            <!-- Data Tests -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-database mr-2"></i>Data Flow Tests
                </h3>
                <div id="data-tests" class="space-y-2"></div>
            </div>
        </div>
        
        <!-- Manual Test Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-hand-pointer mr-2"></i>Manual Tests
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="testLogin()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-sign-in-alt mr-2"></i>Test Login Flow
                </button>
                <button onclick="testDashboard()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-tachometer-alt mr-2"></i>Test Dashboard Load
                </button>
                <button onclick="testUserDropdown()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                    <i class="fas fa-users mr-2"></i>Test User Dropdown
                </button>
                <button onclick="testLeaderboard()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    <i class="fas fa-trophy mr-2"></i>Test Leaderboard
                </button>
            </div>
            <div id="manual-result" class="mt-4"></div>
        </div>
        
        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">Actions</h3>
            <div class="flex gap-4">
                <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>Clear All Data
                </button>
                <button onclick="window.open('index.html', '_blank')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    <i class="fas fa-external-link-alt mr-2"></i>Open App
                </button>
                <button onclick="runAllTests()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-play mr-2"></i>Run All Tests
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load all app scripts -->
    <script src="js/app-config.js"></script>
    <script src="js/startup-coordinator.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Test result helper
        function addTestResult(containerId, test, success, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `flex items-center p-2 rounded ${success ? 'bg-green-50' : 'bg-red-50'}`;
            div.innerHTML = `
                <i class="fas ${success ? 'fa-check text-green-600' : 'fa-times text-red-600'} mr-2"></i>
                <span class="text-sm">${test}: ${message}</span>
            `;
            container.appendChild(div);
        }
        
        // Clear containers
        function clearTests() {
            ['auth-tests', 'api-tests', 'ui-tests', 'data-tests'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }
        
        // Authentication Tests
        async function testAuthentication() {
            const container = 'auth-tests';
            
            // Test 1: Auth module loaded
            if (typeof Auth !== 'undefined') {
                addTestResult(container, 'Module Load', true, 'Auth module loaded');
            } else {
                addTestResult(container, 'Module Load', false, 'Auth module not found');
                return;
            }
            
            // Test 2: No auto-login
            const session = Auth.getSession();
            if (!session || Auth.isSessionExpired(session)) {
                addTestResult(container, 'No Auto-Login', true, 'Requires authentication');
            } else {
                addTestResult(container, 'Session Check', true, `Active session: ${session.user.email}`);
            }
            
            // Test 3: Login page creation
            Auth.createLoginPage();
            const loginPage = document.getElementById('login-page');
            if (loginPage) {
                addTestResult(container, 'Login Page', true, 'Login page created');
                loginPage.remove(); // Clean up
            } else {
                addTestResult(container, 'Login Page', false, 'Failed to create login page');
            }
            
            // Update status
            document.getElementById('auth-status').innerHTML = 
                '<i class="fas fa-check text-green-600"></i> Working';
        }
        
        // API Tests
        async function testAPI() {
            const container = 'api-tests';
            
            // Test 1: API module loaded
            if (typeof API !== 'undefined') {
                addTestResult(container, 'Module Load', true, 'API module loaded');
            } else {
                addTestResult(container, 'Module Load', false, 'API module not found');
                return;
            }
            
            // Test 2: API endpoint test
            try {
                const response = await API.getUsers();
                if (response && response.data) {
                    addTestResult(container, 'Users Endpoint', true, `Loaded ${response.data.length} users`);
                } else {
                    addTestResult(container, 'Users Endpoint', false, 'No data received');
                }
            } catch (error) {
                addTestResult(container, 'Users Endpoint', false, error.message);
            }
            
            // Test 3: Activities endpoint
            try {
                const response = await API.getActivities();
                addTestResult(container, 'Activities Endpoint', true, 'Endpoint accessible');
            } catch (error) {
                addTestResult(container, 'Activities Endpoint', false, error.message);
            }
            
            // Test 4: Goals endpoint
            try {
                const response = await API.getGoals();
                addTestResult(container, 'Goals Endpoint', true, 'Endpoint accessible');
            } catch (error) {
                addTestResult(container, 'Goals Endpoint', false, error.message);
            }
            
            // Update status
            document.getElementById('api-status').innerHTML = 
                '<i class="fas fa-check text-green-600"></i> Connected';
        }
        
        // UI Tests
        function testUI() {
            const container = 'ui-tests';
            
            // Test 1: Main app container
            const mainApp = document.getElementById('main-app');
            if (mainApp) {
                addTestResult(container, 'Main App', true, 'Container exists');
            } else {
                addTestResult(container, 'Main App', false, 'Container not found');
            }
            
            // Test 2: Dashboard section
            const dashboard = document.getElementById('dashboard-section');
            if (dashboard) {
                addTestResult(container, 'Dashboard', true, 'Section exists');
            } else {
                addTestResult(container, 'Dashboard', false, 'Section not found');
            }
            
            // Test 3: Admin controls
            const adminControls = document.getElementById('admin-dashboard-controls');
            if (adminControls) {
                addTestResult(container, 'Admin Controls', true, 'Controls exist');
            } else {
                addTestResult(container, 'Admin Controls', false, 'Controls not found');
            }
            
            // Test 4: User selector
            const userSelector = document.getElementById('admin-selected-user');
            if (userSelector) {
                addTestResult(container, 'User Selector', true, 'Dropdown exists');
            } else {
                addTestResult(container, 'User Selector', false, 'Dropdown not found');
            }
        }
        
        // Data Flow Tests
        async function testDataFlow() {
            const container = 'data-tests';
            
            // Test 1: Load users
            try {
                const users = await API.getUsers();
                if (users && users.data && users.data.length > 0) {
                    addTestResult(container, 'Load Users', true, `${users.data.length} users loaded`);
                    
                    // Test 2: User roles
                    const roles = [...new Set(users.data.map(u => u.role))];
                    addTestResult(container, 'User Roles', true, `Roles: ${roles.join(', ')}`);
                } else {
                    addTestResult(container, 'Load Users', false, 'No users found');
                }
            } catch (error) {
                addTestResult(container, 'Load Users', false, error.message);
            }
            
            // Test 3: Create test data
            try {
                const testActivity = {
                    userId: 'test-user',
                    type: 'test',
                    week: '2025-W03',
                    callsMade: 10,
                    emailsSent: 20
                };
                await API.createActivity(testActivity);
                addTestResult(container, 'Create Activity', true, 'Test activity created');
                
                // Clean up
                const activities = await API.getActivities({ userId: 'test-user' });
                if (activities.data && activities.data.length > 0) {
                    await API.deleteActivity(activities.data[0].id);
                }
            } catch (error) {
                addTestResult(container, 'Create Activity', false, error.message);
            }
            
            // Update status
            document.getElementById('data-status').innerHTML = 
                '<i class="fas fa-check text-green-600"></i> Working';
        }
        
        // Manual test functions
        async function testLogin() {
            const resultDiv = document.getElementById('manual-result');
            resultDiv.innerHTML = '<div class="p-4 bg-blue-50 rounded">Testing login flow...</div>';
            
            // Create a temporary login test
            const testEmail = 'admin@example.com';
            const testPassword = 'admin123';
            
            const result = await Auth.login(testEmail, testPassword);
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        Login successful! User: ${result.user.name} (${result.user.role})
                    </div>
                `;
                // Clear session for testing
                Auth.clearSession();
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <i class="fas fa-times text-red-600 mr-2"></i>
                        Login failed: ${result.error}
                    </div>
                `;
            }
        }
        
        function testDashboard() {
            window.open('index.html#dashboard', '_blank');
        }
        
        async function testUserDropdown() {
            const resultDiv = document.getElementById('manual-result');
            try {
                const users = await API.getUsers();
                const dropdownHTML = users.data.map(u => 
                    `<option>${u.name} (${u.role})</option>`
                ).join('');
                
                resultDiv.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded">
                        <i class="fas fa-check text-green-600 mr-2"></i>
                        User dropdown would contain ${users.data.length} users:
                        <select class="mt-2 w-full p-2 border rounded">${dropdownHTML}</select>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <i class="fas fa-times text-red-600 mr-2"></i>
                        Failed to load users: ${error.message}
                    </div>
                `;
            }
        }
        
        function testLeaderboard() {
            window.open('index.html#leaderboard', '_blank');
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('This will clear all localStorage data. Continue?')) {
                localStorage.clear();
                alert('All data cleared. Refresh the page to continue.');
                location.reload();
            }
        }
        
        // Run all tests
        async function runAllTests() {
            clearTests();
            document.getElementById('manual-result').innerHTML = '';
            
            await testAuthentication();
            await testAPI();
            testUI();
            await testDataFlow();
        }
        
        // Run tests on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>