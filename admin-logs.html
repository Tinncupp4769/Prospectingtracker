<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Audit Logs — ASCM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="ascm/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f8fafc; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .input { border:1px solid #E5E7EB; }
  </style>
  <script>
    (function(){ try{ const s=JSON.parse(localStorage.getItem('ascm_session')||'null'); if(!s){ location.replace('index.html'); return; } if(String((s.role||'')).toLowerCase()!=='admin'){ document.addEventListener('DOMContentLoaded',()=>{ document.body.innerHTML='<div class="max-w-3xl mx-auto mt-10 p-4 rounded-md border bg-red-50 text-red-700">Access denied: Admins only.</div>'; }); } }catch{} })();
  </script>
</head>
<body>
  <header class="brand-gradient text-white" id="header">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-white/10 grid place-items-center"><i class="fa-solid fa-scroll text-white"></i></div>
        <div>
          <h1 class="text-base font-bold">Audit Logs</h1>
          <p class="text-xs text-white/80">Admin-only — review recent actions and sync events</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a id="home-button" href="app.html" class="btn-outline px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-house mr-2"></i>Home</a>
      </div>
    </div>
  </header>
  <script>(function(){ try{ const url=new URL(location.href); if (url.searchParams.get('embed')==='1'){ var h=document.getElementById('header'); if(h) h.style.display='none'; var hb=document.getElementById('home-button'); if(hb) hb.style.display='none'; } }catch{} })();</script>

  <main class="max-w-7xl mx-auto px-6 py-6 space-y-4">
    <div class="card p-4">
      <div class="flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm">Search</label>
          <input id="search" class="input rounded px-2 py-1 text-sm" placeholder="user, action, table, id" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm">Limit</label>
          <input id="limit" type="number" value="200" min="50" max="2000" class="input rounded px-2 py-1 text-sm w-24" />
        </div>
        <span id="apiMode" class="px-2 py-1 text-xs rounded border bg-slate-50 text-slate-700">Checking…</span>
        <button id="refresh" class="btn-outline px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-arrows-rotate mr-2"></i>Refresh</button>
      </div>
    </div>

    <div class="card p-0 overflow-hidden">
      <table class="min-w-full">
        <thead class="bg-slate-50 text-slate-700 text-xs">
          <tr>
            <th class="px-3 py-2 text-left">Time</th>
            <th class="px-3 py-2 text-left">Actor</th>
            <th class="px-3 py-2 text-left">Action</th>
            <th class="px-3 py-2 text-left">Target</th>
            <th class="px-3 py-2 text-left">Details</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div id="empty" class="card p-6 text-sm text-slate-600 hidden">No logs found.</div>
  </main>

  <div id="ascm_toast" class="ascm-toast info" role="status" aria-live="polite"></div>

  <script>
    (function(){
      const qs=(s)=>document.querySelector(s);
      function showToast(msg,type){ const el=qs('#ascm_toast'); if(!el) return; el.className='ascm-toast '+(type||'info'); el.innerHTML='<span>'+msg+'</span><button class="close" aria-label="Dismiss">×</button>'; const b=el.querySelector('.close'); if(b) b.onclick=()=> el.classList.remove('show'); el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 4500); }

      let BASE='tables/'; const CAND=['tables/','/tables/'];
      function looksHtml(res){ return (res.headers.get('content-type')||'').toLowerCase().includes('text/html'); }
      function npath(p){ if(/^https?:/i.test(p)) return p; if(p.startsWith('tables/')) return BASE + p.slice(7); if(p.startsWith('/tables/')) return BASE + p.slice(8); return BASE + p; }
      function fetchWithTimeout(url, options={}, timeoutMs=12000){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs); const opts={ ...options, signal: ctrl.signal, cache:'no-store', credentials:'same-origin' }; return fetch(url, opts).finally(()=> clearTimeout(t)); }
      async function resolveBase(){ for(const b of CAND){ try{ const r=await fetchWithTimeout(`${b}users?limit=1`, { method:'GET' }, 8000); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(r.ok && ct.includes('application/json')){ BASE=b; break; } }catch{} } qs('#apiMode').textContent = BASE; }
      async function apiReq(method, path, body, tries=5){ await resolveBase(); for(let i=0;i<tries;i++){ try{ let url=npath(path); url += (url.includes('?')?'&':'?')+`cb=${Date.now()}_${i}`; const r=await fetchWithTimeout(url,{ method, headers:{'Content-Type':'application/json'}, body: body!=null?JSON.stringify(body):undefined }, 15000); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(!r.ok || looksHtml(r) || (!ct.includes('application/json') && r.status!==204)){ try{ const wu=npath('tables/users?limit=1'); const sep=wu.includes('?')?'&':'?'; await fetchWithTimeout(`${wu}${sep}cb=${Date.now()}`, { method:'GET' }, 6000); }catch{} await new Promise(res=> setTimeout(res, 450*Math.pow(1.7,i) + Math.floor(Math.random()*250))); continue; } return r; }catch(e){ await new Promise(res=> setTimeout(res, 450*Math.pow(1.7,i) + Math.floor(Math.random()*250))); } } throw new Error('API blocked'); }
      async function apiJson(method, path, body, tries=5){ const r=await apiReq(method,path,body,tries); if(r.status===204) return {}; return await r.json(); }

      async function load(){ const s=qs('#search').value.trim(); const limit=Math.max(10, Math.min(2000, parseInt(qs('#limit').value||'200',10)||200)); const q = 'tables/audit_logs?limit='+limit + (s? ('&search='+encodeURIComponent(s)):''); try{ const data=await apiJson('GET', q); const list=data.data||[]; render(list); }catch(e){ showToast('Failed to load logs','error'); render([]); } }
      function render(list){ const tbody=qs('#rows'); const empty=qs('#empty'); if(!list.length){ tbody.innerHTML=''; empty.classList.remove('hidden'); return; } empty.classList.add('hidden'); const rows=list.sort((a,b)=> (b.timestamp||b.performed_at||0)-(a.timestamp||a.performed_at||0)).map(r=>{
        const at = new Date(r.timestamp||r.performed_at||Date.now());
        const actor = r.actor_email || r.performed_by || r.actor_id || '—';
        const action = r.action || '—';
        const target = `${r.target_table||'—'} ${r.target_id||''}`.trim();
        const details = r.details ? (typeof r.details==='string'? r.details : JSON.stringify(r.details)) : '';
        return `<tr class="border-t text-sm">
          <td class="px-3 py-2 whitespace-nowrap">${at.toLocaleString()}</td>
          <td class="px-3 py-2 whitespace-nowrap">${actor}</td>
          <td class="px-3 py-2 whitespace-nowrap">${action}</td>
          <td class="px-3 py-2 whitespace-nowrap">${target}</td>
          <td class="px-3 py-2">${details}</td>
        </tr>`;
      }).join(''); tbody.innerHTML = rows; }

      document.addEventListener('DOMContentLoaded', ()=>{ qs('#refresh').addEventListener('click', load); qs('#search').addEventListener('input', ()=>{ clearTimeout(window._logT); window._logT=setTimeout(load, 350); }); load(); });
    })();
  </script>
</body>
</html>
