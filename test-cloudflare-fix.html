<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Fix Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">
            <i class="fas fa-shield-alt text-green-600 mr-3"></i>
            Cloudflare/API Fix Verification
        </h1>
        
        <!-- Problem Explanation -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <div class="flex">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-semibold text-blue-900">The Real Problem</h3>
                    <p class="text-blue-800 mt-1">The API endpoint is blocked by Cloudflare's protection, returning HTML challenge pages instead of JSON data. This causes 403/500 errors.</p>
                </div>
            </div>
        </div>
        
        <!-- Solution Explanation -->
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
            <div class="flex">
                <i class="fas fa-lightbulb text-green-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-semibold text-green-900">The Solution</h3>
                    <p class="text-green-800 mt-1">Automatically detect Cloudflare blocks and switch to local mock data stored in browser localStorage. The app works fully offline!</p>
                </div>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="testAPIConnection()" class="bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700">
                    <i class="fas fa-network-wired mr-2"></i>Test API Connection
                </button>
                <button onclick="forceMockData()" class="bg-yellow-600 text-white px-4 py-3 rounded hover:bg-yellow-700">
                    <i class="fas fa-database mr-2"></i>Force Mock Data
                </button>
                <button onclick="clearMockData()" class="bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>Clear Mock Data
                </button>
                <button onclick="openApp()" class="bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700">
                    <i class="fas fa-rocket mr-2"></i>Open App
                </button>
            </div>
        </div>
        
        <!-- Status Display -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current Status</h2>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Mock Data Provider</span>
                    <span id="mock-status" class="font-medium">Checking...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>API Status</span>
                    <span id="api-status" class="font-medium">Checking...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Data Mode</span>
                    <span id="data-mode" class="font-medium">Checking...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Local Data</span>
                    <span id="local-data" class="font-medium">Checking...</span>
                </div>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-2"></div>
        </div>
    </div>
    
    <script src="js/mock-data-provider.js"></script>
    
    <script>
        // Check mock data provider
        function checkMockStatus() {
            const mockStatusEl = document.getElementById('mock-status');
            if (typeof MockDataProvider !== 'undefined') {
                mockStatusEl.innerHTML = '<i class="fas fa-check text-green-600"></i> Loaded';
                MockDataProvider.initializeMockData();
            } else {
                mockStatusEl.innerHTML = '<i class="fas fa-times text-red-600"></i> Not loaded';
            }
        }
        
        // Check API status
        async function checkAPIStatus() {
            const apiStatusEl = document.getElementById('api-status');
            apiStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            
            try {
                const response = await fetch('tables/users?limit=1');
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/html')) {
                    // Cloudflare block detected
                    apiStatusEl.innerHTML = '<i class="fas fa-shield-alt text-yellow-600"></i> Blocked by Cloudflare';
                    addResult('API blocked by Cloudflare - Mock data will be used', 'warning');
                } else if (response.ok) {
                    apiStatusEl.innerHTML = '<i class="fas fa-check text-green-600"></i> Working';
                    addResult('API is accessible', 'success');
                } else {
                    apiStatusEl.innerHTML = '<i class="fas fa-times text-red-600"></i> Error ' + response.status;
                    addResult('API returned error ' + response.status, 'error');
                }
            } catch (error) {
                apiStatusEl.innerHTML = '<i class="fas fa-times text-red-600"></i> Unreachable';
                addResult('API is unreachable: ' + error.message, 'error');
            }
        }
        
        // Check data mode
        function checkDataMode() {
            const dataModeEl = document.getElementById('data-mode');
            const usingMock = localStorage.getItem('use_mock_data') === 'true';
            
            if (usingMock) {
                dataModeEl.innerHTML = '<i class="fas fa-database text-yellow-600"></i> Mock Data';
            } else {
                dataModeEl.innerHTML = '<i class="fas fa-server text-blue-600"></i> API Data';
            }
        }
        
        // Check local data
        function checkLocalData() {
            const localDataEl = document.getElementById('local-data');
            const users = JSON.parse(localStorage.getItem('mock_users') || '[]');
            const activities = JSON.parse(localStorage.getItem('mock_activities') || '[]');
            const goals = JSON.parse(localStorage.getItem('mock_goals') || '[]');
            
            localDataEl.innerHTML = `${users.length} users, ${activities.length} activities, ${goals.length} goals`;
        }
        
        // Test API connection
        async function testAPIConnection() {
            addResult('Testing API connection...', 'info');
            await checkAPIStatus();
        }
        
        // Force mock data
        function forceMockData() {
            localStorage.setItem('use_mock_data', 'true');
            if (typeof MockDataProvider !== 'undefined') {
                MockDataProvider.initializeMockData();
            }
            addResult('Forced mock data mode', 'success');
            checkDataMode();
            checkLocalData();
        }
        
        // Clear mock data
        function clearMockData() {
            localStorage.removeItem('use_mock_data');
            localStorage.removeItem('mock_users');
            localStorage.removeItem('mock_activities');
            localStorage.removeItem('mock_goals');
            addResult('Cleared all mock data', 'success');
            checkDataMode();
            checkLocalData();
        }
        
        // Open app
        function openApp() {
            window.open('index.html', '_blank');
        }
        
        // Add result
        function addResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            
            const icons = {
                success: 'check-circle text-green-600',
                error: 'times-circle text-red-600',
                warning: 'exclamation-triangle text-yellow-600',
                info: 'info-circle text-blue-600'
            };
            
            resultDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded';
            resultDiv.innerHTML = `
                <i class="fas fa-${icons[type] || icons.info}"></i>
                <span>${message}</span>
                <span class="text-xs text-gray-500 ml-auto">${new Date().toLocaleTimeString()}</span>
            `;
            
            resultsDiv.appendChild(resultDiv);
            
            // Keep only last 10 results
            while (resultsDiv.children.length > 10) {
                resultsDiv.removeChild(resultsDiv.firstChild);
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            checkMockStatus();
            checkAPIStatus();
            checkDataMode();
            checkLocalData();
            
            addResult('Test suite loaded', 'success');
            addResult('The app will now work even when API is blocked!', 'success');
        });
    </script>
</body>
</html>