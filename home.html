<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home — ASCM Prospecting Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="ascm/css/theme.css">
  <script src="js/theme.js"></script>
  <script src="js/avatars.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f6faf8; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .tile { display:flex; align-items:center; gap:12px; padding:16px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; transition:transform .12s ease, box-shadow .12s ease; box-shadow:0 6px 16px rgba(0,0,0,.05); }
    .tile:hover { transform: translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.08); }
    .ico { width:44px; height:44px; border-radius:12px; display:grid; place-items:center; color:#0b1e17; background:linear-gradient(160deg, rgba(0,107,54,.12) 0%, rgba(130,195,65,.08) 100%), #E6F4EC; }
    .kpi { padding:16px; border-radius:16px; border:1px solid #e5e7eb; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.05); }
    .kpi .label { font-size:12px; color:#64748b; }
    .kpi .value { font-weight:800; font-size:28px; color:#0f172a; line-height:1; }
    .kpi .hint { font-size:12px; color:#0f5132; }
    .btn-big { display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:16px 22px; border-radius:12px; font-weight:700; box-shadow:0 6px 16px rgba(0,0,0,.06); }
    .btn-green { background:#006B36; color:#fff; }
    .btn-green:hover { background:#075a32; }
    .btn-outline { border:1px solid #D1D5DB; background:#fff; color:#0f172a; }
  </style>
  <script>
    // Session guard
    (function(){ try { const s=JSON.parse(localStorage.getItem('ascm_session')||'null'); if(!s){ location.replace('index.html'); return; } } catch{} })();
  </script>
</head>
<body>
  <header class="brand-gradient text-white" id="header">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-white/10 grid place-items-center"><i class="fa-solid fa-house text-white"></i></div>
        <div>
          <h1 class="text-base font-bold">Home</h1>
          <p class="text-xs text-white/80">Welcome back — log activity and check your progress</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a id="home-button" href="app.html" class="btn-outline px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-gauge mr-2"></i>App Shell</a>
      </div>
    </div>
  </header>
  <script>
    (function(){ try{ const url=new URL(location.href); if (url.searchParams.get('embed')==='1'){ var h=document.getElementById('header'); if(h) h.style.display='none'; var hb=document.getElementById('home-button'); if(hb) hb.style.display='none'; } }catch{} })();
  </script>

  <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">
    <!-- Welcome banner -->
    <section class="card p-5 bg-gradient-to-r from-emerald-50 via-white to-emerald-50 border-emerald-100">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-3">
          <img id="avatar" alt="avatar" class="w-12 h-12 rounded-xl hidden" src="https://source.boringavatars.com/beam/80/ascm" />
          <div>
            <div id="welcome" class="text-lg font-extrabold text-emerald-900">Welcome!</div>
            <div class="text-sm text-emerald-800/90">Let’s turn today’s outreach into outcomes. Log your activity and review your KPIs.</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a class="btn-big btn-green" href="activity-entry-router.html?embed=1"><i class="fa-solid fa-pen-to-square"></i>Enter Activity</a>
          <a class="btn-big btn-outline" href="sales-dashboard-modular.html?embed=1"><i class="fa-solid fa-chart-line"></i>Open Dashboard</a>
        </div>
      </div>
    </section>

    <!-- KPI summary -->
    <section>
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-slate-700">This Week</h2>
        <div class="text-xs text-slate-500" id="kpiMeta">Loading…</div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="kpi">
          <div class="label">Calls Made</div>
          <div class="value" id="kpiCalls">0</div>
          <div class="hint" id="kpiCallsHint"></div>
        </div>
        <div class="kpi">
          <div class="label">Emails Sent</div>
          <div class="value" id="kpiEmails">0</div>
          <div class="hint" id="kpiEmailsHint"></div>
        </div>
        <div class="kpi">
          <div class="label">Meetings Logged</div>
          <div class="value" id="kpiMeetings">0</div>
          <div class="hint" id="kpiMeetingsHint"></div>
        </div>
        <div class="kpi">
          <div class="label">Pipeline Value</div>
          <div class="value" id="kpiPipeline">$0</div>
          <div class="hint" id="kpiPipelineHint"></div>
        </div>
      </div>
    </section>

    <!-- Quick nav tiles -->
    <section>
      <h2 class="text-sm font-semibold text-slate-700 mb-2">Quick Navigation</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <a class="tile" href="activity-entry-router.html?embed=1">
          <div class="ico"><i class="fa-solid fa-pen-to-square"></i></div>
          <div>
            <div class="font-bold">Enter Your Prospecting Activity</div>
            <div class="text-sm text-slate-500">Log calls, emails, meetings, ABM, pipeline, and revenue</div>
          </div>
        </a>
        <a class="tile" href="sales-dashboard-modular.html?embed=1">
          <div class="ico"><i class="fa-solid fa-chart-line"></i></div>
          <div>
            <div class="font-bold">Activity Overview Dashboard</div>
            <div class="text-sm text-slate-500">Track KPIs and progress toward goals</div>
          </div>
        </a>
        <a class="tile" href="analytics-react.html?embed=1">
          <div class="ico"><i class="fa-solid fa-chart-area"></i></div>
          <div>
            <div class="font-bold">Analytics</div>
            <div class="text-sm text-slate-500">Trends, KPIs, heatmaps, and tables</div>
          </div>
        </a>
        <a class="tile" href="leaderboard.html?embed=1">
          <div class="ico"><i class="fa-solid fa-trophy"></i></div>
          <div>
            <div class="font-bold">Leaderboard</div>
            <div class="text-sm text-slate-500">See top performers and rankings</div>
          </div>
        </a>
        <a id="tileSetGoals" class="tile" href="goals-portal.html?embed=1">
          <div class="ico"><i class="fa-solid fa-bullseye"></i></div>
          <div>
            <div class="font-bold">Set Goals</div>
            <div class="text-sm text-slate-500">Weekly and monthly goals for AE/AM</div>
          </div>
        </a>
        <a id="tileAdminUsers" class="tile hidden" href="admin-users.html?embed=1">
          <div class="ico"><i class="fa-solid fa-user-gear"></i></div>
          <div>
            <div class="font-bold">User Management</div>
            <div class="text-sm text-slate-500">Manage users, roles, and access</div>
          </div>
        </a>
        <a id="tileGoalsAdmin" class="tile hidden" href="goals-portal.html?embed=1">
          <div class="ico"><i class="fa-solid fa-bullseye"></i></div>
          <div>
            <div class="font-bold">Goals Portal</div>
            <div class="text-sm text-slate-500">Admin snapshot-first goals management</div>
          </div>
        </a>
      </div>
    </section>

    <!-- Notifications / Reminders -->
    <section>
      <h2 class="text-sm font-semibold text-slate-700 mb-2">Notifications</h2>
      <div id="notif" class="card p-4 text-sm text-slate-700">
        <div class="flex items-start gap-3"><i class="fa-regular fa-bell mt-1 text-emerald-700"></i><div id="notifBody">Loading reminders…</div></div>
      </div>
    </section>
  </main>

  <div id="ascm_toast" class="ascm-toast info" role="status" aria-live="polite"></div>

  <script>
  (function(){
    const qs=(s)=>document.querySelector(s);
    const now=()=>Date.now();
    function fmtMoney(n){ n=Number(n||0); const k=n/1000; return '$'+(k>=1? k.toFixed(0)+'K' : n.toFixed(0)); }
    function showToast(msg,type){ const el=qs('#ascm_toast'); if(!el) return; el.className='ascm-toast '+(type||'info'); el.innerHTML='<span>'+msg+'</span><button class="close" aria-label="Dismiss">×</button>'; const b=el.querySelector('.close'); if(b) b.onclick=()=> el.classList.remove('show'); el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 4500); }

    function getSession(){ try { return JSON.parse(localStorage.getItem('ascm_session')||'null'); } catch{ return null; } }
    const sess = getSession();
    (function hydrateHeader(){ try{ const name=sess?.name||sess?.email||''; const el=qs('#welcome'); if (el) el.textContent = name? ('Welcome back, '+name+'!') : 'Welcome!'; const av=qs('#avatar'); if (av && sess){ try{ if (window.Avatars){ av.outerHTML = Avatars.img2x(sess, 48, 'w-12 h-12 rounded-xl'); } else { av.src = sess.avatar_url || `https://source.boringavatars.com/beam/80/${encodeURIComponent(sess.email||sess.name||'ascm')}`; av.classList.remove('hidden'); } }catch{} } }catch{} })();
    // Update avatar/name when session changes
    window.addEventListener('storage', (e)=>{ if (e.key==='ascm_session'){ try{ const s=JSON.parse(e.newValue||'null'); const wl=qs('#welcome'); if (wl) wl.textContent = s?.name?('Welcome back, '+s.name+'!'):(s?.email?('Welcome back, '+s.email+'!'):'Welcome!'); const avatarHost=document.querySelector('#header img.w-12, #avatar'); if (avatarHost && window.Avatars && s){ avatarHost.outerHTML = Avatars.img2x(s, 48, 'w-12 h-12 rounded-xl'); } }catch{} } });

    // Admin tiles visibility + Set Goals behavior
    (function gateAdmin(){ try{ const role=(sess?.role||'').toLowerCase(); const isAdmin = role==='admin'; if (isAdmin){ qs('#tileAdminUsers')?.classList.remove('hidden'); qs('#tileGoalsAdmin')?.classList.remove('hidden'); } else {
      // Keep Set Goals tile visible but clarify it requires admin (local client gate)
      const t = qs('#tileSetGoals'); if (t){ const hint=t.querySelector('.text-sm'); if(hint) hint.textContent='Admin-managed goals. Ask your admin to update.'; t.addEventListener('click', (e)=>{ e.preventDefault(); showToast('Goals are managed by Admins in this environment.','info'); }); }
    } }catch{} })();

    // Resilient API helpers
    let API_BASE='tables/'; const CAND=['tables/','/tables/'];
    function looksLikeHtml(res){ const ct=(res.headers.get('content-type')||'').toLowerCase(); return ct.includes('text/html'); }
    function normalizePath(p){ if (/^https?:\/\//i.test(p)) return p; if (p.startsWith('tables/')) return API_BASE + p.slice('tables/'.length); if (p.startsWith('/tables/')) return API_BASE + p.slice('/tables/'.length); return p; }
    function fetchWithTimeout(url, options={}, timeoutMs=12000){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs); const opts={ ...options, signal: ctrl.signal, cache:'no-store', credentials:'same-origin' }; return fetch(url, opts).finally(()=> clearTimeout(t)); }
    async function resolveApiBase(){ for (const b of CAND){ try{ const r=await fetchWithTimeout(`${b}activities?limit=1`, { method:'GET' }, 8000); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(r.ok && ct.includes('application/json')){ API_BASE=b; break; } }catch{} } }
    async function apiRequest(method, path, body, tries=5){ await resolveApiBase(); for (let i=0;i<tries;i++){ try{ let url=normalizePath(path); url += (url.includes('?')?'&':'?')+`cb=${Date.now()}_${i}`; const r=await fetchWithTimeout(url, { method, headers:{'Content-Type':'application/json'}, body: body!=null?JSON.stringify(body):undefined }, 15000); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(!r.ok || looksLikeHtml(r) || (!ct.includes('application/json') && r.status!==204)){
          try{ const wu=normalizePath('tables/users?limit=1'); const sep=wu.includes('?')?'&':'?'; await fetchWithTimeout(`${wu}${sep}cb=${Date.now()}`, { method:'GET' }, 6000); }catch{}
          await new Promise(res=> setTimeout(res, 400*Math.pow(1.7,i) + Math.floor(Math.random()*200)));
          continue;
        }
        return r;
      }catch(e){ await new Promise(res=> setTimeout(res, 400*Math.pow(1.7,i) + Math.floor(Math.random()*200))); }
    }
      throw new Error('API blocked'); }
    async function apiJson(method, path, body, tries=5){ const r=await apiRequest(method,path,body,tries); if (r.status===204) return {}; return await r.json(); }

    function startOfWeek(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; }
    function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(s.getDate()+6); e.setHours(23,59,59,999); return e; }
    function isToday(ts){ const d=new Date(ts); const t=new Date(); const d0=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0); const d1=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999); return d>=d0 && d<=d1; }

    async function loadKPIs(){
      const imp = (function(){ try{ return JSON.parse(localStorage.getItem('ascm_impersonate')||'null'); }catch{ return null; } })();
      const activeUserId = (imp?.id || sess?.id || null);
      const role = (imp?.role || (sess?.role||'ae')).toLowerCase();
      const weekStart = startOfWeek(new Date()); const weekEnd = endOfWeek(new Date());
      let rows=[]; let fromCache=false;
      try {
        const data = await apiJson('GET','tables/activities?limit=2000');
        rows = data?.data || [];
        localStorage.setItem('activities', JSON.stringify(rows));
      } catch(e){ try{ rows = JSON.parse(localStorage.getItem('activities')||'[]'); fromCache = true; }catch{ rows=[]; } }
      const mine = rows.filter(a => (!activeUserId || String(a.userId)===String(activeUserId)) && ((a.role||role).toLowerCase()===role));
      const w = mine.filter(a=>{ const ts=a.date? new Date(a.date).getTime() : (a.createdAt||Date.now()); return ts>=weekStart.getTime() && ts<=weekEnd.getTime(); });
      const calls = w.reduce((s,a)=> s + Number(a.callsMade||0), 0);
      const emails = w.reduce((s,a)=> s + Number(a.emailsSent||0), 0);
      const meetings = w.reduce((s,a)=> s + Number(a.meetingsBooked||0) + Number(a.meetingsConducted||0), 0);
      const pipeline = w.reduce((s,a)=> s + Number(a.pipelineGenerated||0), 0);
      const todayCount = mine.filter(a=> isToday(a.date? new Date(a.date).getTime() : (a.createdAt||Date.now()))).length;
      qs('#kpiCalls').textContent = calls.toString();
      qs('#kpiEmails').textContent = emails.toString();
      qs('#kpiMeetings').textContent = meetings.toString();
      qs('#kpiPipeline').textContent = fmtMoney(pipeline);
      qs('#kpiCallsHint').textContent = todayCount>0? `${todayCount} entries today` : 'No entries today yet';
      qs('#kpiEmailsHint').textContent = '';
      qs('#kpiMeetingsHint').textContent = '';
      qs('#kpiPipelineHint').textContent = 'Prospecting pipeline';
      const meta = fromCache ? 'Cached' : 'Live';
      qs('#kpiMeta').textContent = `${meta} · Week of ${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
      return { rows: mine, week: { calls, emails, meetings, pipeline }, today: todayCount };
    }

    async function loadGoalsSnapshot(){
      try {
        const ym = new Date().toISOString().slice(0,7);
        const snap = await apiJson('GET', `tables/goals_snapshots?limit=1&search=${encodeURIComponent(ym)}`);
        const row = (snap.data||[]).find(x=> !x.deleted && x.month===ym && !x.userId);
        return !!row;
      } catch { return false; }
    }

    function renderNotifications(k, hasSnap){
      const lines=[];
      if (k.today===0) lines.push('You have not logged any activity today. Tap Enter Activity to add one now.');
      if (!hasSnap){
        const role = (sess?.role||'ae').toLowerCase();
        if (role==='admin') lines.push('No goals snapshot published for this month yet. Open Goals Portal to publish snapshot.');
      }
      if (!lines.length) lines.push('All clear! Keep up the great work.');
      qs('#notifBody').innerHTML = '<ul class="list-disc ml-5 space-y-1">' + lines.map(t=> `<li>${t}</li>`).join('') + '</ul>';
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      const k = await loadKPIs();
      const hasSnap = await loadGoalsSnapshot();
      renderNotifications(k, hasSnap);
    });
  })();
  </script>
</body>
</html>
