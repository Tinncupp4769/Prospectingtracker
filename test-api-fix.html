<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Connectivity Test & Fix Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">
            <i class="fas fa-network-wired text-blue-600 mr-3"></i>
            API Connectivity Test
        </h1>
        
        <!-- Problem Summary -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <div class="flex">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-semibold text-blue-900">Issues Fixed</h3>
                    <ul class="list-disc list-inside mt-2 text-blue-700">
                        <li>API showing as "not available" - Fixed with automatic detection</li>
                        <li>Seamless fallback to mock data when API is blocked</li>
                        <li>Duplicate initialization causing conflicts</li>
                        <li>Better user notification when in offline mode</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- API Status Check -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-server mr-2"></i>API Status
            </h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>API Endpoint</span>
                    <span id="api-endpoint" class="font-mono text-sm">Checking...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>API Status</span>
                    <span id="api-status" class="font-medium">
                        <i class="fas fa-spinner fa-spin"></i> Checking...
                    </span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Data Mode</span>
                    <span id="data-mode" class="font-medium">Detecting...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Mock Data Status</span>
                    <span id="mock-status" class="font-medium">Checking...</span>
                </div>
            </div>
            
            <div class="mt-4 flex gap-3">
                <button onclick="checkAPI()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-sync-alt mr-2"></i>Recheck API
                </button>
                <button onclick="forceMockMode()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                    <i class="fas fa-database mr-2"></i>Force Mock Mode
                </button>
                <button onclick="clearAndRetry()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-redo mr-2"></i>Clear & Retry API
                </button>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-vial mr-2"></i>Functionality Tests
            </h2>
            <div id="test-results" class="space-y-3"></div>
            <button onclick="runAllTests()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                <i class="fas fa-play mr-2"></i>Run All Tests
            </button>
        </div>
        
        <!-- Login Test -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-sign-in-alt mr-2"></i>Login Test
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="test-email" value="bmiller@ascm.org" 
                           class="w-full p-2 border rounded" placeholder="Enter any email">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="test-password" value="test123" 
                           class="w-full p-2 border rounded" placeholder="Any password works in mock mode">
                </div>
            </div>
            <button onclick="testLogin()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 w-full">
                <i class="fas fa-user-check mr-2"></i>Test Login
            </button>
            <div id="login-result" class="mt-4"></div>
        </div>
    </div>
    
    <!-- Load all dependencies -->
    <script src="js/app-config.js"></script>
    <script src="js/mock-data-provider.js"></script>
    <script src="js/mock-notifier.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Check API status
        async function checkAPI() {
            const endpointEl = document.getElementById('api-endpoint');
            const statusEl = document.getElementById('api-status');
            const modeEl = document.getElementById('data-mode');
            const mockEl = document.getElementById('mock-status');
            
            // Show endpoint
            endpointEl.textContent = API.baseURL || '/tables/*';
            
            // Check API availability
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            
            try {
                // Force recheck
                API.apiChecked = false;
                const available = await API.checkAPIAvailability();
                
                if (available) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> Online';
                    statusEl.className = 'font-medium text-green-600';
                    modeEl.innerHTML = '<i class="fas fa-cloud text-blue-600"></i> Using Live API';
                    modeEl.className = 'font-medium text-blue-600';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-times-circle text-red-600"></i> Blocked/Offline';
                    statusEl.className = 'font-medium text-red-600';
                    modeEl.innerHTML = '<i class="fas fa-database text-yellow-600"></i> Using Mock Data';
                    modeEl.className = 'font-medium text-yellow-600';
                }
            } catch (error) {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600"></i> Error';
                statusEl.className = 'font-medium text-red-600';
                modeEl.innerHTML = '<i class="fas fa-database text-yellow-600"></i> Fallback to Mock';
                modeEl.className = 'font-medium text-yellow-600';
            }
            
            // Check mock data status
            const usingMock = localStorage.getItem('use_mock_data') === 'true';
            const hasUsers = localStorage.getItem('mock_users');
            
            if (usingMock && hasUsers) {
                const users = JSON.parse(hasUsers);
                mockEl.innerHTML = `<i class="fas fa-check text-green-600"></i> Active (${users.length} users)`;
                mockEl.className = 'font-medium text-green-600';
            } else if (usingMock) {
                mockEl.innerHTML = '<i class="fas fa-check text-yellow-600"></i> Active (initializing)';
                mockEl.className = 'font-medium text-yellow-600';
            } else {
                mockEl.innerHTML = '<i class="fas fa-minus text-gray-400"></i> Not Active';
                mockEl.className = 'font-medium text-gray-400';
            }
        }
        
        // Force mock mode
        function forceMockMode() {
            localStorage.setItem('use_mock_data', 'true');
            API.forceUseMock = true;
            API.apiAvailable = false;
            
            if (typeof MockDataProvider !== 'undefined') {
                MockDataProvider.initializeMockData();
            }
            
            if (typeof MockNotifier !== 'undefined') {
                MockNotifier.show();
            }
            
            checkAPI();
            addTestResult('Mode Switch', true, 'Switched to mock data mode');
        }
        
        // Clear and retry
        async function clearAndRetry() {
            localStorage.removeItem('use_mock_data');
            API.forceUseMock = false;
            API.apiChecked = false;
            
            await checkAPI();
        }
        
        // Add test result
        function addTestResult(test, success, message) {
            const container = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `p-3 rounded flex items-center ${success ? 'bg-green-50' : 'bg-red-50'}`;
            div.innerHTML = `
                <i class="fas ${success ? 'fa-check text-green-600' : 'fa-times text-red-600'} mr-3"></i>
                <div>
                    <div class="font-medium">${test}</div>
                    <div class="text-sm text-gray-600">${message}</div>
                </div>
            `;
            container.appendChild(div);
        }
        
        // Run all tests
        async function runAllTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            // Test 1: API Module
            if (typeof API !== 'undefined') {
                addTestResult('API Module', true, 'API module loaded successfully');
            } else {
                addTestResult('API Module', false, 'API module not found');
                return;
            }
            
            // Test 2: Mock Data Provider
            if (typeof MockDataProvider !== 'undefined') {
                addTestResult('Mock Provider', true, 'Mock data provider loaded');
                MockDataProvider.initializeMockData();
            } else {
                addTestResult('Mock Provider', false, 'Mock data provider not found');
            }
            
            // Test 3: API Check
            const available = await API.checkAPIAvailability();
            addTestResult('API Check', true, available ? 'API is online' : 'API blocked, using mock data');
            
            // Test 4: Data Fetch
            try {
                const users = await API.getUsers();
                addTestResult('Data Fetch', true, `Successfully fetched ${users.data ? users.data.length : 0} users`);
            } catch (error) {
                addTestResult('Data Fetch', false, `Error: ${error.message}`);
            }
            
            // Test 5: Auth Module
            if (typeof Auth !== 'undefined') {
                addTestResult('Auth Module', true, 'Authentication module loaded');
            } else {
                addTestResult('Auth Module', false, 'Authentication module not found');
            }
            
            // Test 6: Mock Notifier
            if (typeof MockNotifier !== 'undefined') {
                addTestResult('Notifier', true, 'Mock notifier available');
            } else {
                addTestResult('Notifier', false, 'Mock notifier not found');
            }
        }
        
        // Test login
        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('login-result');
            
            if (!email) {
                resultDiv.className = 'p-4 bg-red-50 border border-red-200 rounded';
                resultDiv.innerHTML = '<i class="fas fa-times text-red-600 mr-2"></i>Please enter an email';
                return;
            }
            
            try {
                const result = await Auth.login(email, password || 'test');
                
                if (result.success) {
                    resultDiv.className = 'p-4 bg-green-50 border border-green-200 rounded';
                    resultDiv.innerHTML = `
                        <div class="font-semibold text-green-900">
                            <i class="fas fa-check-circle mr-2"></i>Login Successful!
                        </div>
                        <div class="text-sm text-green-700 mt-2">
                            <div>User: ${result.user.name}</div>
                            <div>Role: ${result.user.platformRole}</div>
                            <div>Mode: ${localStorage.getItem('use_mock_data') === 'true' ? 'Mock Data' : 'Live API'}</div>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Login failed');
                }
            } catch (error) {
                resultDiv.className = 'p-4 bg-red-50 border border-red-200 rounded';
                resultDiv.innerHTML = `
                    <div class="font-semibold text-red-900">
                        <i class="fas fa-times-circle mr-2"></i>Login Failed
                    </div>
                    <div class="text-sm text-red-700 mt-2">${error.message}</div>
                `;
            }
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            await checkAPI();
            
            // Auto-run tests after a short delay
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>