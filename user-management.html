<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management — ASCM Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="ascm/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    .chip { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Header -->
  <header class="brand-gradient text-white">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-white/10 grid place-items-center"><i class="fa-solid fa-users-gear"></i></div>
        <div>
          <h1 class="text-base font-bold">User Management</h1>
          <p class="text-xs text-white/80">Admins can manage AMs and AEs</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a id="home-button" href="app.html" class="btn-outline px-3 py-2 rounded-md text-sm">Home</a>
        <span id="apiStatus" class="px-2 py-1 text-xs rounded border bg-slate-100 border-slate-200 text-slate-600" title="Data source status">Checking…</span>
        <button id="reloadBtn" class="btn-outline px-3 py-2 rounded-md text-sm">Reload</button>
        <button id="addUserBtn" class="btn-primary px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-user-plus mr-2"></i>Add User</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6">
    <!-- Notice: New hardened Users Console available -->
    <div class="mb-4 bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg px-4 py-3 text-sm">
      Looking for the hardened Admin Users Console? It is recommended for live deployments. <a href="admin-users.html" class="underline font-semibold">Open Admin Users Console</a>.
    </div>
    <!-- Controls -->
    <div class="bg-white border rounded-xl p-4 mb-4 grid gap-3 md:grid-cols-2 lg:grid-cols-4">
      <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
        <input id="searchInput" type="text" placeholder="Search by name or email" class="input w-full rounded-md pl-9 py-2">
      </div>
      <select id="filterRole" class="input rounded-md py-2">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="am">Account Manager</option>
        <option value="ae">Account Executive</option>
      </select>
      <select id="filterTeam" class="input rounded-md py-2">
        <option value="">All Teams</option>
      </select>
      <select id="filterStatus" class="input rounded-md py-2">
        <option value="">All Statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>

    <!-- Bulk actions -->
    <div class="flex items-center justify-between mb-2">
      <div class="flex gap-2">
        <button id="bulkActivate" class="btn-accent px-3 py-2 rounded-md text-sm disabled:opacity-50" disabled><i class="fa-solid fa-toggle-on mr-2"></i>Activate</button>
        <button id="bulkDeactivate" class="btn-outline px-3 py-2 rounded-md text-sm disabled:opacity-50" disabled><i class="fa-solid fa-toggle-off mr-2"></i>Deactivate</button>
        <button id="bulkDelete" class="btn-outline px-3 py-2 rounded-md text-sm text-red-600 border-red-200 disabled:opacity-50" disabled><i class="fa-solid fa-trash mr-2"></i>Delete</button>
      </div>
      <div class="text-sm text-slate-600"><span id="selectedCount">0</span> selected</div>
    </div>

    <!-- Leaderboard Metric Weights (Admin-only) -->
    <section id="weightsAdminPanel" class="bg-white border rounded-xl p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">Leaderboard Metric Weights</h3>
        <div class="flex items-center gap-2">
          <label for="weightsScope" class="text-sm text-slate-600">Scope</label>
          <select id="weightsScope" class="input rounded-md py-1.5 text-sm">
            <option value="ae">AE</option>
            <option value="am">AM</option>
          </select>
          <button id="weightsReload" class="btn-outline px-3 py-1.5 rounded-md text-sm">Reload</button>
          <button id="weightsSave" class="btn-primary px-3 py-1.5 rounded-md text-sm"><i class="fa-solid fa-floppy-disk mr-2"></i>Save</button>
        </div>
      </div>
      <div id="weightsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      <div id="weightsHint" class="text-xs text-slate-500 mt-2">Values apply only to the selected scope. Defaults are used when no weight exists for a metric.</div>
    </section>

    <!-- Table -->
    <div class="overflow-x-auto bg-white border rounded-xl">
      <table class="min-w-full">
        <thead class="bg-slate-50 text-slate-700 text-xs">
          <tr>
            <th class="px-4 py-3 text-left w-10"><input id="selectAll" type="checkbox"></th>
            <th class="px-4 py-3 text-left cursor-pointer" data-sort="name">Name <i class="fa-solid fa-sort text-slate-400"></i></th>
            <th class="px-4 py-3 text-left cursor-pointer" data-sort="role">Role</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-left">Phone</th>
            <th class="px-4 py-3 text-left">Team/Region</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody" class="text-sm"></tbody>
      </table>
      <div id="emptyState" class="hidden p-8 text-center text-slate-500">No users found.</div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between mt-4">
      <div class="text-sm text-slate-600">Showing <span id="rangeLabel">0–0</span> of <span id="totalLabel">0</span></div>
      <div class="flex gap-2">
        <button id="prevPage" class="btn-outline px-3 py-2 rounded-md text-sm">Prev</button>
        <button id="nextPage" class="btn-outline px-3 py-2 rounded-md text-sm">Next</button>
      </div>
    </div>
  </main>

  <!-- Toast (using global .ascm-toast) -->
  <div id="um_toast" class="hidden"></div>

  <!-- Danger Zone: Full Data Reset -->
  <section class="max-w-7xl mx-auto px-6">
    <div class="mt-6 bg-white border rounded-xl p-5">
      <h3 class="text-lg font-semibold text-red-600 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</h3>
      <p class="text-sm text-slate-600 mt-1">Reset all activity data across the app. This preserves users, roles, and settings. Use only in test environments.</p>
      <button id="openResetBtn" class="btn-outline px-3 py-2 rounded-md text-sm text-red-600 border-red-200 mt-3"><i class="fa-solid fa-broom mr-2"></i>Reset All Data</button>
      <div id="resetProgress" class="hidden text-sm text-slate-600 mt-2"></div>
    </div>
  </section>

  <!-- Add/Edit Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="card rounded-xl w-full max-w-xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Add User</h3>
        <button id="closeModal" class="text-slate-500 hover:text-slate-900"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalAlert" class="hidden rounded-md p-3 text-sm mb-3"></div>
      <form id="userForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="userId">
        <div>
          <label class="block text-sm font-medium">Full Name</label>
          <input id="fName" type="text" class="input w-full rounded-md px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Email</label>
          <input id="fEmail" type="email" class="input w-full rounded-md px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Role</label>
          <select id="fRole" class="input w-full rounded-md px-3 py-2" required>
            <option value="ae">Account Executive</option>
            <option value="am">Account Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Team/Region</label>
          <input id="fTeam" type="text" class="input w-full rounded-md px-3 py-2" placeholder="e.g., East, West, EMEA">
        </div>
        <div>
          <label class="block text-sm font-medium">Phone</label>
          <input id="fPhone" type="tel" class="input w-full rounded-md px-3 py-2">
        </div>
        <div class="flex items-center gap-2 mt-7">
          <input id="fActive" type="checkbox" class="rounded border-slate-300" checked>
          <label for="fActive" class="text-sm">Active</label>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Avatar URL</label>
          <input id="fAvatar" type="url" class="input w-full rounded-md px-3 py-2" placeholder="https://...">
          <div id="avatarSuggestions" class="mt-2 grid grid-cols-6 gap-2"></div>
          <p class="text-xs text-slate-500 mt-1">Tip: Pick a default avatar below or paste your own image URL.</p>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Temporary Password</label>
          <div class="flex gap-2">
            <input id="fTempPassword" type="text" class="input w-full rounded-md px-3 py-2" placeholder="Auto-generate or enter" />
            <button type="button" id="genPwd" class="btn-outline rounded-md px-3">Generate</button>
          </div>
          <p class="text-xs text-slate-500 mt-1">Password will be hashed client-side before saving.</p>
        </div>
        <div class="md:col-span-2 flex items-center gap-2 mt-2">
          <input id="fMfa" type="checkbox" class="rounded border-slate-300">
          <label for="fMfa" class="text-sm">Two-Factor Authentication Enabled</label>
        </div>
        <div class="md:col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" id="cancelModal" class="btn-outline rounded-md px-4 py-2">Cancel</button>
          <button type="submit" class="btn-primary rounded-md px-4 py-2">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div id="confirmDialog" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="card rounded-xl w-full max-w-md p-5">
      <h3 class="text-lg font-semibold mb-2">Confirm Action</h3>
      <p id="confirmText" class="text-sm text-slate-600 mb-4">Are you sure?</p>
      <div class="flex justify-end gap-2">
        <button id="confirmCancel" class="btn-outline rounded-md px-4 py-2">Cancel</button>
        <button id="confirmOk" class="btn-primary rounded-md px-4 py-2">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Full Reset Confirm Modal -->
  <div id="resetModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="card rounded-xl w-full max-w-md p-5">
      <h3 class="text-lg font-semibold mb-2 text-red-600">Confirm Full Data Reset</h3>
      <p class="text-sm text-slate-700 mb-3">This will permanently delete ALL activity data (activities, pipeline/opportunity numbers) and clear cached metrics. Users and settings are preserved. Type <strong>RESET</strong> to confirm.</p>
      <input id="resetConfirmInput" type="text" placeholder="Type RESET to confirm" class="input w-full rounded-md px-3 py-2 mb-4">
      <div class="flex justify-end gap-2">
        <button id="resetCancel" class="btn-outline rounded-md px-4 py-2">Cancel</button>
        <button id="resetOk" class="btn-primary rounded-md px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50" disabled>
          <i class="fa-solid fa-trash-can mr-2"></i>Reset</button>
      </div>
    </div>
  </div>

  <script>
    // Simple RBAC gate — only allow admins
    function getSession(){ try { return JSON.parse(localStorage.getItem('ascm_session')||'null'); } catch { return null; } }
    const session = getSession();
    if (!session) window.location.replace('index.html');
    // Enforce admin access for this page
    if ((String(session.role||'').toLowerCase()) !== 'admin') { window.location.replace('app.html'); }

    // Utilities
    // API base detection and normalization + status badge
    let API_BASE = 'tables/';
    const API_BASE_CANDIDATES = ['tables/','/tables/'];
    function normalizePath(p){ if (/^https?:\/\//i.test(p)) return p; if (p.startsWith('tables/')) return API_BASE + p.slice('tables/'.length); if (p.startsWith('/tables/')) return API_BASE + p.slice('/tables/'.length); return p; }
    async function resolveApiBase(){ for (const base of API_BASE_CANDIDATES){ try{ const r = await fetch(`${base}users?limit=1`, { cache:'no-store', credentials:'same-origin' }); const ct=(r.headers.get('content-type')||'').toLowerCase(); if (r.ok && ct.includes('application/json')) { API_BASE = base; break; } }catch{} } }
    function setApiStatus(mode){ window._apiStatusMode = mode || 'checking'; const el=document.getElementById('apiStatus'); if(!el) return; const base='px-2 py-1 text-xs rounded border '; if(mode==='live'){ el.className=base+'bg-emerald-50 border-emerald-200 text-emerald-700'; el.textContent='Live'; } else if(mode==='cached'){ el.className=base+'bg-blue-50 border-blue-200 text-blue-700'; el.textContent='Cached'; } else if(mode==='offline'){ el.className=base+'bg-red-50 border-red-200 text-red-700'; el.textContent='Offline'; } else { el.className=base+'bg-slate-100 border-slate-200 text-slate-600'; el.textContent='Checking…'; } }
    async function sha256(str) {
      const enc = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function show(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
    function hide(el){ el.classList.add('hidden'); el.classList.remove('flex'); }
    // Lightweight toast UI
    function notify(msg, type='info'){ showToast(msg, type); }
    function showToast(msg, type='info'){
      try {
        let el = document.getElementById('ascm_toast');
        if (!el) { el = document.createElement('div'); el.id='ascm_toast'; el.className='ascm-toast info'; document.body.appendChild(el); }
        el.classList.remove('success','error','info');
        el.classList.add(type||'info');
        el.innerHTML = `<span>${String(msg||'')}</span><button class='close' aria-label='Dismiss'>×</button>`;
        const btn = el.querySelector('.close'); if (btn) btn.onclick = ()=> el.classList.remove('show');
        el.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>{ el.classList.remove('show'); }, 5000);
      } catch{}
    }
    function toast(msg){ try{ const p=document.getElementById('resetProgress'); if(p){ p.textContent = msg; p.classList.remove('hidden'); } }catch{} }
    function toast(msg){ try{ const p=document.getElementById('resetProgress'); if(p){ p.textContent=msg; p.classList.remove('hidden'); } }catch{} }
    function formatRole(role){ return role==='admin'?'Admin':role==='am'?'Account Manager':'Account Executive'; }

    // Local-only Users fallback (for environments blocking POST to /tables/*)
    function loadLocalUsers(){ try { return JSON.parse(localStorage.getItem('ascm_local_users')||'[]'); } catch { return []; } }
    function saveLocalUsers(list){ try { localStorage.setItem('ascm_local_users', JSON.stringify(list)); } catch {} }
    function upsertLocalUser(user){ const list = loadLocalUsers(); const idx = list.findIndex(x => x.id===user.id || (String(x.email||'').toLowerCase()===String(user.email||'').toLowerCase())); if (idx>=0) list[idx]=user; else list.push(user); saveLocalUsers(list); return user; }
    function findLocalUserById(id){ return loadLocalUsers().find(x=>x.id===id)||null; }
    function removeLocalUser(id){ saveLocalUsers(loadLocalUsers().filter(x=>x.id!==id)); }
    function genLocalId(email){ return 'local:'+ Date.now().toString(36) + ':' + Math.random().toString(36).slice(2,8); }
    function isLocalId(id){ return String(id||'').startsWith('local:'); }
    function isPostBlockedError(err){ const m = String(err && err.message || ''); return /403|blocked|api request failed|api blocked|html/i.test(m); }
    // Schema whitelist to ensure payload compliance
    const USER_FIELDS_WHITELIST = ['name','email','role','team','phone','is_active','avatar_url','mfa_enabled','password_hash','last_login'];
    function filterUserPayload(p){ const out={}; USER_FIELDS_WHITELIST.forEach(k=>{ if (p[k] !== undefined) out[k]=p[k]; }); return out; }

    // Pagination state
    const sleep=(ms)=> new Promise(r=>setTimeout(r,ms));
    function looksLikeHtml(res){ const ct=(res.headers?.get?.('content-type')||'').toLowerCase(); return ct.includes('text/html'); }
    async function apiRequest(method, path, body, tries=7){ let warned=false; for(let i=0;i<tries;i++){ let url = normalizePath(path); const sep = url.includes('?') ? '&' : '?'; url = `${url}${sep}cb=${Date.now()}_${i}`; const res=await fetch(url,{ method, headers:{'Content-Type':'application/json'}, body: body!=null?JSON.stringify(body):undefined, cache:'no-store', credentials:'same-origin' }); if(res.status===401||res.status===403||looksLikeHtml(res)){ if(!warned){warned=true;} try{ let wu = normalizePath('tables/users?limit=1'); const wsep = wu.includes('?') ? '&' : '?'; await fetch(`${wu}${wsep}cb=${Date.now()}`,{ cache:'no-store', credentials:'same-origin' }); }catch{} await sleep(800*(i+1)); continue; } return res; } throw new Error('API blocked'); }

    // Background auto-recovery for API connectivity
    function scheduleAutoRecover(){ if (window._umRecoverTimer) return; const attempt = async ()=>{ if (document.hidden) return; if (window._apiStatusMode==='live'){ clearInterval(window._umRecoverTimer); window._umRecoverTimer=null; return; } try{ await fetch(normalizePath('tables/users?limit=1'),{ cache:'no-store', credentials:'same-origin' }); await fetchUsers(); setApiStatus('live'); clearInterval(window._umRecoverTimer); window._umRecoverTimer=null; }catch(e){ /* keep trying */ } }; window._umRecoverTimer = setInterval(attempt, 15000); attempt(); }
    async function apiJson(method, path, body, tries=3){ const res=await apiRequest(method,path,body,tries); if(!res.ok){ let t=''; try{t=await res.text();}catch{}; throw new Error(method+' '+path+' -> '+res.status+' '+t.slice(0,120)); } if(res.status===204) return {}; try{ return await res.json(); }catch{ return {}; } }
    let state = { page: 1, limit: 10, total: 0, sortField: 'name', sortDir: 'asc', selected: new Set(), filters: { role:'', team:'', status:'', search:'' } };

    // Elements
    const tbody = document.getElementById('usersTbody');
    const emptyState = document.getElementById('emptyState');
    const selectAll = document.getElementById('selectAll');
    const selectedCount = document.getElementById('selectedCount');
    const rangeLabel = document.getElementById('rangeLabel');
    const totalLabel = document.getElementById('totalLabel');

    // Load teams dynamically from existing users
    async function fetchAllUsers(pageSize=500){
      // Prefer a single fat fetch first (more reliable behind some CDNs)
      try { const fat = await apiJson('GET','tables/users?limit=2000'); if (fat && Array.isArray(fat.data)) return fat.data; } catch(e1){}
      const all=[]; let page=1, total=0, seen=0; const byId=new Map(); const byEmail=new Map(); let guard=0;
      try {
        do {
          const j = await apiJson('GET', `tables/users?page=${page}&limit=${pageSize}`);
          const rows = j.data || [];
          for (const u of rows){
            const idKey = String(u.id||''); const emKey = String(u.email||'').toLowerCase();
            if (idKey && !byId.has(idKey)){ byId.set(idKey,true); all.push(u); }
            else if (emKey && !byEmail.has(emKey)) { byEmail.set(emKey,true); all.push(u); }
          }
          total = j.total || all.length;
          seen += rows.length;
          page++; guard++;
          if (guard>5000) break; // safety guard
        } while (seen < total && page < 2000);
        if (!all.length){ const fat2 = await apiJson('GET','tables/users?limit=2000'); return fat2.data||[]; }
        return all;
      } catch (e) {
        // Fallback: single large page
        try { const j = await apiJson('GET','tables/users?limit=2000'); return j.data||[]; }
        catch(e2){ throw e2; }
      }
    }

    async function loadTeams() {
      const rows = await fetchAllUsers(500);
      const teams = Array.from(new Set((rows||[]).map(u => u.team).filter(Boolean))).sort();
      const sel = document.getElementById('filterTeam');
      sel.innerHTML = '<option value="">All Teams</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    // Fetch users (client-side filtering due to demo API) with resiliency and caching
    async function fetchUsers() {
      try {
        let rows = await fetchAllUsers(500);
        rows = (rows || []).filter(u => !u.deleted);
        // Merge local-only users if any (avoid duplicates by email)
        try {
          const local = loadLocalUsers();
          const serverEmails = new Set(rows.map(u => String(u.email||'').toLowerCase()))
          rows = rows.concat(local.filter(u => !serverEmails.has(String(u.email||'').toLowerCase())));
        } catch {}
        // Persist canonical set and timestamp for diagnostics
        try { localStorage.setItem('um_users', JSON.stringify(rows)); localStorage.setItem('users', JSON.stringify(rows)); localStorage.setItem('um_users_ts', String(Date.now())); } catch{}
        setApiStatus('live');

        // Filters
        const { search, role, team, status } = state.filters;
        if (search) rows = rows.filter(u => (u.name||'').toLowerCase().includes(search) || (u.email||'').toLowerCase().includes(search));
        if (role) rows = rows.filter(u => (u.role||'') === role);
        if (team) rows = rows.filter(u => (u.team||'') === team);
        if (status) rows = rows.filter(u => status==='active' ? u.is_active !== false : u.is_active === false);

        // Sort
        rows.sort((a,b) => {
          const f = state.sortField; const dir = state.sortDir==='asc'?1:-1;
          const va = (a[f]||'').toString().toLowerCase();
          const vb = (b[f]||'').toString().toLowerCase();
          return va>vb?dir:va<vb?-dir:0;
        });

        state.total = rows.length;

        // Paginate
        const start = (state.page-1)*state.limit;
        const pageRows = rows.slice(start, start+state.limit);

        renderTable(pageRows);
        totalLabel.textContent = state.total;
        const end = Math.min(start + pageRows.length, state.total);
        rangeLabel.textContent = state.total? `${start+1}–${end}`:'0–0';
      } catch (e) {
        console.warn('fetchUsers failed', e);
        // Notify anomalies
        try { notify('User list fetch failed; showing cached data if available. See console for details.','warn'); } catch{}
        // Try cached (user-management cache, then global users cache used by other pages)
        try {
          let cached = [];
          try { cached = JSON.parse(localStorage.getItem('um_users')||'[]'); } catch{}
          if (!cached.length){
            try { cached = JSON.parse(localStorage.getItem('users')||'[]'); } catch{}
          }
          if (cached.length) {
            setApiStatus('cached');
            // merge local cached with server-cached
            let cachedMerged = cached;
            try {
              const local = loadLocalUsers();
              const serverEmails = new Set(cached.map(u => String(u.email||'').toLowerCase()));
              cachedMerged = cached.concat(local.filter(u => !serverEmails.has(String(u.email||'').toLowerCase())));
            } catch {}
            state.total = cachedMerged.length;
            const start = (state.page-1)*state.limit;
            const pageRows = cachedMerged.slice(start, start+state.limit);
            renderTable(pageRows);
            totalLabel.textContent = state.total;
            const end = Math.min(start + pageRows.length, state.total);
            rangeLabel.textContent = state.total? `${start+1}–${end}`:'0–0';
          } else {
            setApiStatus('offline');
          }
        } catch { setApiStatus('offline'); }
        scheduleAutoRecover();
      }
    }

    function renderTable(rows) {
      if (!rows.length) { tbody.innerHTML=''; emptyState.classList.remove('hidden'); return; }
      emptyState.classList.add('hidden');
      tbody.innerHTML = rows.map(u => {
        const active = u.is_active !== false; const img = (window.Avatars ? Avatars.img2x(u, 32, 'rounded-full') : `<img src="${u.avatar_url||'https://source.boringavatars.com/beam/40/'+encodeURIComponent(u.email||u.name||'user')}" class="w-8 h-8 rounded-full" alt="${u.name||''}">`);
        return `<tr class="border-t">
          <td class="px-4 py-3"><input type="checkbox" data-id="${u.id}" class="rowChk"></td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-3">
              ${img}
              <div>
                <div class="font-medium">${u.name||'-'} ${((u.id||'').toString().startsWith('local:'))?'<span class=\"ml-2 chip bg-blue-50 text-blue-700\">LOCAL</span>':''}</div>
                <div class="text-xs text-slate-500">${u.email||''}</div>
              </div>
            </div>
          </td>
          <td class="px-4 py-3">${formatRole(u.role||'ae')}</td>
          <td class="px-4 py-3">${u.email||''}</td>
          <td class="px-4 py-3">${u.phone||'-'}</td>
          <td class="px-4 py-3">${u.team||'-'}</td>
          <td class="px-4 py-3">
            <span class="chip ${active?'bg-emerald-50 text-emerald-700':'bg-red-50 text-red-600'}">${active?'Active':'Inactive'}</span>
          </td>
          <td class="px-4 py-3 text-right">
            <button class="text-slate-600 hover:text-slate-900 mr-3" data-action="edit" data-id="${u.id}"><i class="fa-solid fa-pen-to-square"></i></button>
            <button class="text-slate-600 hover:text-slate-900 mr-3" data-action="password" data-id="${u.id}"><i class="fa-solid fa-key"></i></button>
            <button class="${active?'text-red-600':'text-emerald-700'} hover:opacity-80" data-action="toggle" data-id="${u.id}"><i class="fa-solid ${active?'fa-user-slash':'fa-user-check'}"></i></button>
            <button class="text-slate-600 hover:text-red-700 ml-3" data-action="delete" data-id="${u.id}"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>`;
      }).join('');

      // Wire row checkboxes
      document.querySelectorAll('.rowChk').forEach(chk => {
        chk.addEventListener('change', (e)=>{ const id=e.target.dataset.id; e.target.checked?state.selected.add(id):state.selected.delete(id); updateBulkState(); });
      });

      // Wire action buttons
      tbody.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', onRowAction);
      });

      // Select all sync
      selectAll.checked = false; state.selected.clear(); updateBulkState();
    }

    function updateBulkState(){
      const n = state.selected.size; selectedCount.textContent = n;
      document.getElementById('bulkActivate').disabled = n===0;
      document.getElementById('bulkDeactivate').disabled = n===0;
      document.getElementById('bulkDelete').disabled = n===0;
    }

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', ()=>{
        const field = th.dataset.sort; 
        state.sortField = field; state.sortDir = state.sortDir==='asc'?'desc':'asc';
        fetchUsers();
      })
    });

    // Filters & search
    document.getElementById('searchInput').addEventListener('input', e => { state.filters.search = e.target.value.toLowerCase(); state.page=1; fetchUsers(); });
    document.getElementById('filterRole').addEventListener('change', e => { state.filters.role = e.target.value; state.page=1; fetchUsers(); });
    document.getElementById('filterTeam').addEventListener('change', e => { state.filters.team = e.target.value; state.page=1; fetchUsers(); });
    document.getElementById('filterStatus').addEventListener('change', e => { state.filters.status = e.target.value; state.page=1; fetchUsers(); });

    // Pagination
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (state.page>1) { state.page--; fetchUsers(); } });
    document.getElementById('nextPage').addEventListener('click', ()=>{ const max = Math.ceil(state.total/state.limit)||1; if (state.page<max) { state.page++; fetchUsers(); } });

    // Select all
    selectAll.addEventListener('change', (e)=>{
      tbody.querySelectorAll('.rowChk').forEach(chk => { chk.checked = e.target.checked; const id=chk.dataset.id; e.target.checked?state.selected.add(id):state.selected.delete(id); });
      updateBulkState();
    });

    // Row actions
    function onRowAction(e){
      const id = e.currentTarget.dataset.id; const action = e.currentTarget.dataset.action;
      if (action==='edit') return openEdit(id);
      if (action==='password') return resetPassword(id);
      if (action==='toggle') return toggleActive(id);
      if (action==='delete') return removeUser(id);
    }

    // Modal logic
    const userModal = document.getElementById('userModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalAlert = document.getElementById('modalAlert');
    const userForm = document.getElementById('userForm');

    document.getElementById('addUserBtn').addEventListener('click', ()=> openAdd());
    document.getElementById('closeModal').addEventListener('click', ()=> hide(userModal));
    document.getElementById('cancelModal').addEventListener('click', ()=> hide(userModal));

    function openAdd(){
      modalTitle.textContent = 'Add User';
      userForm.reset();
      document.getElementById('userId').value = '';
      document.getElementById('fActive').checked = true;
      hide(modalAlert);
      renderAvatarChoices();
      show(userModal);
    }

    async function openEdit(id){
      let u = null;
      if (isLocalId(id)) { u = findLocalUserById(id); }
      else { u = await apiJson('GET', `tables/users/${id}`); }
      modalTitle.textContent = 'Edit User';
      document.getElementById('userId').value = id;
      document.getElementById('fName').value = u.name||'';
      document.getElementById('fEmail').value = u.email||'';
      document.getElementById('fRole').value = u.role||'ae';
      document.getElementById('fTeam').value = u.team||'';
      document.getElementById('fPhone').value = u.phone||'';
      document.getElementById('fActive').checked = u.is_active !== false;
      document.getElementById('fAvatar').value = u.avatar_url||'';
      document.getElementById('fMfa').checked = !!u.mfa_enabled;
      hide(modalAlert);
      renderAvatarChoices();
      show(userModal);
    }

    function showModalAlert(msg, type='info'){
      modalAlert.className = 'alert rounded-md p-3 text-sm mb-3';
      if (type==='error') modalAlert.classList.add('error');
      if (type==='warn') modalAlert.classList.add('warn');
      modalAlert.textContent = msg; show(modalAlert);
    }

    // Generate random password
    document.getElementById('genPwd').addEventListener('click', ()=>{
      const pwd = crypto.getRandomValues(new Uint32Array(4)).join('-');
      document.getElementById('fTempPassword').value = pwd;
    });

    // Avatar suggestions helper
    function renderAvatarChoices(){
      const emailEl = document.getElementById('fEmail');
      const avatarEl = document.getElementById('fAvatar');
      const wrap = document.getElementById('avatarSuggestions'); if (!wrap) return;
      const seed = (emailEl?.value || 'user').trim() || 'user';
      const urls = [
        `https://source.boringavatars.com/beam/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`,
        `https://source.boringavatars.com/ring/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`,
        `https://source.boringavatars.com/bauhaus/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`,
        `https://source.boringavatars.com/marble/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`,
        `https://source.boringavatars.com/pixel/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`,
        `https://source.boringavatars.com/sunset/80/${encodeURIComponent(seed)}?colors=006B36,3BB14A,82C341,21C0DB,F3F4F6`
      ];
      wrap.innerHTML = urls.map(u=>`<button type="button" class="border rounded overflow-hidden hover:opacity-80"><img src="${u}" alt="avatar" class="w-10 h-10"></button>`).join('');
      wrap.querySelectorAll('button').forEach((btn, i)=> btn.addEventListener('click', ()=>{ avatarEl.value = urls[i]; notify('Avatar selected','success'); }));
      emailEl?.addEventListener('input', ()=>{ // re-render when email changes
        renderAvatarChoices._deb && clearTimeout(renderAvatarChoices._deb);
        renderAvatarChoices._deb = setTimeout(renderAvatarChoices, 250);
      }, { once: true });
    }

    // Save (add or edit)
    userForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); hide(modalAlert);
      const id = document.getElementById('userId').value;
      const basePayload = {
        name: document.getElementById('fName').value.trim(),
        email: document.getElementById('fEmail').value.trim().toLowerCase(),
        role: document.getElementById('fRole').value,
        team: document.getElementById('fTeam').value.trim(),
        phone: document.getElementById('fPhone').value.trim(),
        is_active: document.getElementById('fActive').checked,
        avatar_url: document.getElementById('fAvatar').value.trim(),
        mfa_enabled: document.getElementById('fMfa').checked
      };

      const tempPwd = document.getElementById('fTempPassword').value.trim();
      if (tempPwd) basePayload.password_hash = await sha256(tempPwd);

      try {
        if (id) {
          if (isLocalId(id)) {
            const updated = { ...(findLocalUserById(id)||{}), ...filterUserPayload(basePayload), id };
            upsertLocalUser(updated);
          } else {
            await apiJson('PATCH', `tables/users/${id}`, filterUserPayload(basePayload));
          }
        } else {
          const createPayload = filterUserPayload({ ...basePayload, last_login: Date.now() });
          try {
            console.log('[UM] POST tables/users', createPayload);
            await apiJson('POST', 'tables/users', createPayload);
          } catch (postErr) {
            console.warn('[UM] POST tables/users failed, falling back if blocked', postErr);
            if (isPostBlockedError(postErr)) {
              const localUser = { id: genLocalId(basePayload.email), ...createPayload, created_at: Date.now(), _local: true };
              upsertLocalUser(localUser);
              notify('User saved locally (server blocked POST). See Deployment Diagnostics.', 'warn');
              showModalAlert('Server blocked POST to /tables/users — saved locally only. Allow POST on /tables/* or run Deployment Diagnostics.', 'warn');
            } else { throw postErr; }
          }
        }
        await fetchUsers();
        hide(userModal);
        notify('User saved', 'success');
        try { localStorage.setItem('users', JSON.stringify(JSON.parse(localStorage.getItem('um_users')||'[]'))); localStorage.setItem('um_users_updated', String(Date.now())); } catch{}
        try { if (!window._ascmChan) window._ascmChan = new BroadcastChannel('ascm_sync'); window._ascmChan.postMessage({ type:'users_updated', at: Date.now() }); } catch{}
      } catch (err) {
        console.error(err);
        const msg = (err && err.message) ? String(err.message).slice(0,300) : 'Unknown error';
        showModalAlert('Could not save user: ' + msg + ' — open deployment-diagnostics.html for checks.', 'error');
        notify('Could not save user', 'error');
      }
    });

    // Reset password
    async function resetPassword(id){
      const pwd = prompt('Enter a new temporary password (leave empty to auto-generate)');
      const np = pwd && pwd.trim() ? pwd.trim() : crypto.getRandomValues(new Uint32Array(4)).join('-');
      try {
        if (isLocalId(id)) {
          const u = findLocalUserById(id)||{};
          u.password_hash = await sha256(np);
          upsertLocalUser(u);
        } else {
          await apiJson('PATCH', `tables/users/${id}`, { password_hash: await sha256(np) });
        }
        notify('Password reset. Share the temporary password securely.', 'success');
      } catch(err){ console.error(err); notify('Reset failed','error'); }
    }

    // Toggle active
    async function toggleActive(id){
      try {
        if (isLocalId(id)) {
          const current = findLocalUserById(id)||{};
          upsertLocalUser({ ...current, is_active: current.is_active===false });
        } else {
          const current = await apiJson('GET', `tables/users/${id}`);
          await apiJson('PATCH', `tables/users/${id}`, { is_active: current.is_active===false });
        }
        await fetchUsers();
        notify('User status updated', 'success');
      } catch (err) { console.error(err); notify('Action failed','error'); }
    }

    // Delete
    async function removeUser(id){
      const ok = confirm('This will remove the user. Continue?');
      if (!ok) return;
      try {
        if (isLocalId(id)) { removeLocalUser(id); }
        else { await apiJson('DELETE', `tables/users/${id}`); }
        await fetchUsers(); notify('User deleted', 'success');
      }
      catch(err){ console.error(err); notify('Delete failed','error'); }
    }

    // Bulk actions
    document.getElementById('bulkActivate').addEventListener('click', ()=>bulkToggle(true));
    document.getElementById('bulkDeactivate').addEventListener('click', ()=>bulkToggle(false));
    document.getElementById('bulkDelete').addEventListener('click', bulkDelete);

    async function bulkToggle(val){
      try {
        const count = state.selected.size;
        await Promise.all(Array.from(state.selected).map(id => apiJson('PATCH', `tables/users/${id}`, { is_active: val })));
        state.selected.clear(); updateBulkState(); await fetchUsers();
        notify(`${val? 'Activated' : 'Deactivated'} ${count} user${count===1?'':'s'}`, 'success');
      } catch(err){ console.error(err); notify('Bulk action failed','error'); }
    }
    async function bulkDelete(){
      if (!confirm('Delete selected users?')) return;
      try {
        const count = state.selected.size;
        await Promise.all(Array.from(state.selected).map(id => apiJson('DELETE', `tables/users/${id}`)));
        state.selected.clear(); updateBulkState(); await fetchUsers();
        notify(`Deleted ${count} user${count===1?'':'s'}`, 'success');
      } catch(err){ console.error(err); notify('Bulk delete failed','error'); }
    }

    // Initialize
    (async function initUM(){
      setApiStatus('checking');
      // Render instantly from cache if present, to avoid an empty page in published builds
      try {
        let cached = JSON.parse(localStorage.getItem('um_users')||'[]');
        if (!Array.isArray(cached)) cached = [];
        if (!cached.length){
          // Seed baseline from current session to avoid blank UI in Live
          try{
            const sess = getSession();
            if (sess && sess.email){
              const localSeed = { id:'local:seed:'+Date.now().toString(36), name: sess.name||sess.email, email: (sess.email||'').toLowerCase(), role: (sess.role||'ae'), is_active:true, avatar_url: sess.avatar_url||`https://source.boringavatars.com/beam/40/${encodeURIComponent(sess.email||sess.name||'user')}`, _local:true, created_at: Date.now() };
              cached = [localSeed];
              localStorage.setItem('um_users', JSON.stringify(cached));
              localStorage.setItem('users', JSON.stringify(cached));
            }
          }catch{}
        }
        if (cached.length){
          state.total = cached.length;
          const start = (state.page-1)*state.limit;
          renderTable(cached.slice(start, start+state.limit));
          totalLabel.textContent = state.total;
          const end = Math.min(start + Math.min(state.limit,cached.length), state.total);
          rangeLabel.textContent = state.total? `${start+1}–${end}`:'0–0';
          setApiStatus('cached');
        }
      } catch {}
      await resolveApiBase();
      try{ const wu = normalizePath('tables/users?limit=1'); const wsep = wu.includes('?') ? '&' : '?'; await fetch(`${wu}${wsep}cb=${Date.now()}`, { cache:'no-store', credentials:'same-origin' }); }catch{}
      // Load teams and users independently; do not block users list on teams failure
      const tasks = await Promise.allSettled([loadTeams(), fetchUsers()]);
      if (tasks.some(t => t.status==='rejected')){ scheduleAutoRecover(); }
      // Auto-refresh on visibility regain
      document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) fetchUsers().catch(()=>{}); });
      // React to cache updates from other tabs/pages
      window.addEventListener('storage', (e)=>{ if (e.key==='um_users'){ try{ fetchUsers(); } catch{} } });
      // Reload button
      document.getElementById('reloadBtn')?.addEventListener('click', async ()=>{
        setApiStatus('checking');
        try {
          try { await fetch(normalizePath('tables/users?limit=1'), { cache:'no-store', credentials:'same-origin' }); } catch{}
          const j = await apiJson('GET','tables/users?limit=2000');
          try { localStorage.setItem('um_users', JSON.stringify(j.data||[])); } catch{}
          await fetchUsers();
          setApiStatus('live');
        } catch(err){
          console.warn('Reload failed', err);
          try {
            const cached = JSON.parse(localStorage.getItem('um_users')||'[]');
            if (cached.length){ setApiStatus('cached'); renderTable(cached.slice(0,state.limit)); }
            else setApiStatus('offline');
          } catch{ setApiStatus('offline'); }
        }
      });
    })();

    // ===== Leaderboard Metric Weights (Admin-only) =====
    const DEFAULT_WEIGHTS = {
      callsMade:1, emailsSent:1, linkedinMessages:1, vidyardVideos:1,
      meetingsBooked:6, successfulContacts:3, meetingsConducted:5, opportunitiesGenerated:8, referralsGenerated:4,
      pipelineGenerated:12, revenueClosed:15,
      accountsTargeted:2, generalAbmCampaigns:3, crossSellAbmCampaigns:3, upSellAbmCampaigns:3, dormantAbmCampaigns:3
    };

    const AE_METRICS = ['callsMade','emailsSent','linkedinMessages','vidyardVideos','meetingsBooked','successfulContacts','meetingsConducted','opportunitiesGenerated','referralsGenerated','pipelineGenerated','revenueClosed'];
    const AM_EXTRA = ['accountsTargeted','generalAbmCampaigns','crossSellAbmCampaigns','upSellAbmCampaigns','dormantAbmCampaigns'];
    function metricsForScope(scope){ return scope==='am' ? [...AE_METRICS, ...AM_EXTRA] : AE_METRICS; }
    function renderWeightsGrid(values, scope){
      const grid = document.getElementById('weightsGrid'); if (!grid) return;
      const keys = metricsForScope(scope||'ae');
      grid.innerHTML = keys.map(k=>{
        const val = Number(values?.[k] ?? DEFAULT_WEIGHTS[k]) || 0;
        return `<label class="block text-sm">
          <div class="text-slate-700">${k}</div>
          <input type="number" step="0.1" data-weight="${k}" class="input w-full rounded-md px-3 py-2 mt-1" value="${val}">
        </label>`;
      }).join('');
    }

    async function loadWeightsForScope(scope){
      const base = { ...DEFAULT_WEIGHTS };
      try {
        const j = await apiJson('GET','tables/leaderboard_weights?limit=1000');
        const rows = j.data||[];
        rows.filter(w=> (String(w.role_scope||'')===String(scope))).forEach(w=>{
          const k = String(w.metric||''); if (!k) return;
          base[k] = Number(w.weight)||0;
        });
        try { localStorage.setItem('lb_weights_'+scope, JSON.stringify(base)); } catch{}
        setApiStatus('live');
        renderWeightsGrid(base, scope);
      } catch(e){
        console.warn('loadWeightsForScope failed', e);
        try {
          const cached = JSON.parse(localStorage.getItem('lb_weights_'+scope)||'null');
          if (cached) { setApiStatus('cached'); renderWeightsGrid(cached, scope); return; }
        } catch{}
        setApiStatus('offline');
        renderWeightsGrid(base, scope);
        scheduleAutoRecover();
      }
    }

    function collectWeightsFromGrid(){
      const inputs = document.querySelectorAll('#weightsGrid [data-weight]');
      const map = {}; inputs.forEach(inp=>{ map[inp.dataset.weight] = Number(inp.value)||0; });
      return map;
    }

    async function saveWeightsScope(){
      const scopeSel = document.getElementById('weightsScope'); if (!scopeSel) return;
      const scope = scopeSel.value || 'ae';
      const values = collectWeightsFromGrid();
      const session = getSession();
      const payloads = Object.keys(values).map(k=>({ metric:k, weight:Number(values[k])||0, role_scope:scope, updated_by: session?.email||session?.id||'admin', updated_at: Date.now() }));
      try {
        await Promise.all(payloads.map(p=> apiJson('POST','tables/leaderboard_weights', p)));
        try { localStorage.setItem('lb_weights_'+scope, JSON.stringify(values)); } catch{}
        notify(`Weights saved for ${scope.toUpperCase()}`, 'success');
      } catch(err){
        console.error(err);
        const msg = (err && err.message) ? String(err.message).slice(0,200) : 'Unknown error';
        notify('Could not save weights: ' + msg, 'error');
      }
    }

    function initWeightsPanel(){
      const panel = document.getElementById('weightsAdminPanel'); if (!panel) return;
      const scopeSel = document.getElementById('weightsScope');
      const btnSave = document.getElementById('weightsSave');
      const btnReload = document.getElementById('weightsReload');
      scopeSel.addEventListener('change', ()=> loadWeightsForScope(scopeSel.value||'ae'));
      btnReload.addEventListener('click', ()=> loadWeightsForScope(scopeSel.value||'all'));
      btnSave.addEventListener('click', saveWeightsScope);
      // initial
      loadWeightsForScope(scopeSel.value||'all');
    }

    // Initialize weights panel
    initWeightsPanel();

    // ===== Full Data Reset (Admin-only) =====
    const resetModal = document.getElementById('resetModal');
    const resetInput = document.getElementById('resetConfirmInput');
    const resetOk = document.getElementById('resetOk');
    const resetCancel = document.getElementById('resetCancel');
    const openResetBtn = document.getElementById('openResetBtn');
    const resetProgress = document.getElementById('resetProgress');

    function showReset(){ show(resetModal); resetInput.value=''; resetOk.disabled=true; }
    function hideReset(){ hide(resetModal); }

    openResetBtn?.addEventListener('click', showReset);
    resetCancel?.addEventListener('click', hideReset);
    resetInput?.addEventListener('input', ()=>{ resetOk.disabled = (resetInput.value.trim().toUpperCase()!=='RESET'); });

    async function logAudit(action, details){
      try {
        const actor = session?.id || 'unknown';
        await apiJson('POST','tables/audit_logs',{ action, details, target_table:'activities', target_id:'*', actor_id: actor, actor_email: session?.email||'', timestamp: Date.now() });
      } catch(e){ console.warn('audit log failed', e); }
    }

    async function deleteAllInTable(table){
      let page=1, limit=500, totalDeleted=0, total=0;
      while(true){
        const res = await apiJson('GET', `tables/${table}?page=${page}&limit=${limit}`);
        const rows = res.data||[]; if (!rows.length) break;
        if (!total) total = res.total || rows.length;
        const batchSize = 50;
        for (let i=0;i<rows.length;i+=batchSize){
          const batch = rows.slice(i,i+batchSize);
          await Promise.all(batch.map(r=> apiJson('DELETE', `tables/${table}/${r.id}`)));
          totalDeleted += batch.length; toast(`Deleted ${totalDeleted}/${total} from ${table}…`);
        }
        page++;
      }
      return totalDeleted;
    }

    async function fullDataReset(){
      try{
        toast('Starting reset: loading activities…');
        const deletedActivities = await deleteAllInTable('activities');
        // Optional: clear ephemeral leaderboard caches if present (preserve weights)
        try { await deleteAllInTable('leaderboard_cache'); } catch{}
        // Clear client-side caches
        try { localStorage.removeItem('activities'); localStorage.removeItem('activityDraft'); } catch{}
        try { localStorage.setItem('ascm_week_reset', String(Date.now())); localStorage.setItem('ascm_activities_updated', String(Date.now())); } catch{}
        try { if (!window._ascmChan) window._ascmChan = new BroadcastChannel('ascm_sync'); window._ascmChan.postMessage({ type:'activities_reset', at: Date.now() }); } catch {}
        toast('Reset complete.');
        await logAudit('full_reset', { deleted_activities: deletedActivities });
        notify('All activity data has been reset.', 'success');
        hideReset();
      }catch(err){
        console.error(err);
        notify('Reset failed. See console for details.', 'error');
      }
    }

    resetOk?.addEventListener('click', fullDataReset);
  </script>
</body>
  <script src="js/avatars.js"></script>
</body>
</html>
