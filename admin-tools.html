<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Tools — Master Reset</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="ascm/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#f8fafc; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .status-ribbon{ position:sticky; top:0; z-index:50; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge{ border-radius:999px; padding:2px 8px; font-size:11px; }
  </style>
  <script>
    // Admin-only access gate (client-side)
    (function(){ try{ const s=JSON.parse(localStorage.getItem('ascm_session')||'null'); if(!s){ location.replace('index.html'); return; } if(String((s.role||'')).toLowerCase()!=='admin'){ document.addEventListener('DOMContentLoaded',()=>{ document.body.innerHTML='<div class="max-w-3xl mx-auto mt-10 p-4 rounded-md border bg-red-50 text-red-700">Access denied: Admins only.</div>'; }); } }catch{} })();
  </script>
</head>
<body>
  <header class="brand-gradient text-white" id="header">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-white/10 grid place-items-center"><i class="fa-solid fa-screwdriver-wrench text-white"></i></div>
        <div>
          <h1 class="text-base font-bold">Admin Tools</h1>
          <p class="text-xs text-white/80">TEST ONLY — Master Reset utilities for activities and goals</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a id="home-button" href="app.html" class="btn-outline px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-house mr-2"></i>Home</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-6 space-y-4">
    <div id="ribbon" class="status-ribbon hidden"></div>

    <div class="card p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-bold">Master Reset (TEST ONLY)</div>
          <div class="text-sm text-slate-600">Reset all users' activities and goals to zero for testing. This is irreversible. Use Sandbox Mode to simulate without live writes.</div>
        </div>
        <span class="badge bg-amber-100 text-amber-800 font-bold">ADMIN</span>
      </div>
      <div class="mt-3 flex items-center gap-3 flex-wrap">
        <label class="text-sm inline-flex items-center gap-2"><input id="confirmChk" type="checkbox" class="rounded border-slate-300"> I understand this is TEST ONLY and irreversible</label>
        <span id="apiMode" class="text-xs px-2 py-1 rounded border bg-slate-50 text-slate-700">Checking…</span>
        <label class="text-xs inline-flex items-center gap-2 ml-2"><input id="sandboxChk" type="checkbox" class="rounded border-slate-300"> Sandbox Mode (no live writes)</label>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <button id="btnDryRun" class="btn-outline px-3 py-2 rounded-md text-sm" disabled><i class="fa-solid fa-magnifying-glass mr-2"></i>Dry Run (Count Only)</button>
          <button id="btnResetActivities" class="btn-outline px-3 py-2 rounded-md text-sm text-red-700 border-red-300" disabled><i class="fa-solid fa-trash mr-2"></i>Reset Activities Only</button>
          <button id="btnResetGoals" class="btn-outline px-3 py-2 rounded-md text-sm text-red-700 border-red-300" disabled><i class="fa-solid fa-bullseye mr-2"></i>Reset Goals Only</button>
        </div>
        <div class="space-y-2">
          <button id="btnMasterReset" class="btn-primary px-3 py-2 rounded-md text-sm bg-red-600 hover:bg-red-700" disabled><i class="fa-solid fa-bomb mr-2"></i>Master Reset (Activities + Goals)</button>
          <div class="text-xs text-slate-600">Buttons enable only after confirming the checkbox.</div>
        </div>
      </div>

      <!-- Confirm Modal -->
      <div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
        <div class="card w-full max-w-xl p-5">
          <div class="flex items-start justify-between">
            <div>
              <div id="confirmTitle" class="text-lg font-bold">Confirm Reset</div>
              <div id="confirmDesc" class="text-sm text-slate-600 mt-1">This will reset data. This action is irreversible.</div>
            </div>
            <button id="confirmClose" class="text-slate-500 hover:text-slate-900"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="mt-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-md p-3 text-sm">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i>
            Warning: This operation permanently deletes the selected data. This cannot be undone.
          </div>
          <label class="mt-3 text-sm inline-flex items-center gap-2"><input id="confirmUnderstand" type="checkbox" class="rounded border-slate-300"> I understand this action is irreversible</label>
          <div class="mt-4 flex items-center justify-end gap-2">
            <button id="confirmCancel" class="btn-outline px-4 py-2 rounded-md">Cancel</button>
            <button id="confirmDo" class="btn-primary px-4 py-2 rounded-md bg-red-600 hover:bg-red-700" disabled>Confirm Reset</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="font-bold mb-2">Progress</div>
        <div id="progress" class="text-sm"></div>
      </div>
      <div class="card p-4">
        <div class="font-bold mb-2">Last Action (JSON)</div>
        <pre id="jsonOut" class="mono text-xs whitespace-pre-wrap"></pre>
      </div>
    </div>
  </main>
  <script>
    (function(){ try{ const url=new URL(location.href); if (url.searchParams.get('embed')==='1'){ var h=document.getElementById('header'); if(h) h.style.display='none'; var hb=document.getElementById('home-button'); if(hb) hb.style.display='none'; } }catch{} })();
  </script>

  <div id="ascm_toast" class="ascm-toast info" role="status" aria-live="polite"></div>

  <script>
    (function(){
      const qs=(s)=>document.querySelector(s);
      const now=()=>Date.now();
      function showRibbon(msg,type){ const el=qs('#ribbon'); if(!el) return; const c= type==='error'?'bg-red-50 text-red-800 border-red-200':'bg-emerald-50 text-emerald-800 border-emerald-200'; el.className='status-ribbon card p-3 border '+c; el.innerHTML='<div class="text-sm">'+msg+'</div>'; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 4000); }
      function showToast(msg,type){ const el=qs('#ascm_toast'); if(!el) return; el.className='ascm-toast '+(type||'info'); el.innerHTML='<span>'+msg+'</span><button class="close" aria-label="Dismiss">×</button>'; const b=el.querySelector('.close'); if(b) b.onclick=()=> el.classList.remove('show'); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 5000); }
function openConfirm(kind){ const m=qs('#confirmModal'); const t=qs('#confirmTitle'); const d=qs('#confirmDesc'); const doBtn=qs('#confirmDo'); const cb=qs('#confirmUnderstand'); if(!m) return; const map={ activities:{ title:'Reset Activities', desc:'Delete ALL activities for all users.' }, goals:{ title:'Reset Goals', desc:'Delete ALL goals and snapshots, then publish a zeroed snapshot.' }, master:{ title:'MASTER RESET', desc:'Delete ALL activities, goals, and snapshots, then publish a zeroed snapshot.' } }; const cfg=map[kind]||map.master; t.textContent=cfg.title; d.textContent=cfg.desc; cb.checked=false; doBtn.disabled=true; m.classList.remove('hidden'); m.classList.add('flex'); function onChk(){ doBtn.disabled = !cb.checked; } cb.addEventListener('change', onChk, { once:false }); function close(){ m.classList.add('hidden'); m.classList.remove('flex'); cb.removeEventListener('change', onChk); } qs('#confirmClose').onclick=close; qs('#confirmCancel').onclick=close; return { doBtn, close }; }
async function logAudit(action, details){ try{ const s=JSON.parse(localStorage.getItem('ascm_session')||'null'); const entry={ action, target_table:'admin_tools', target_id:'master_reset', actor_id:s?.id||'', actor_email:s?.email||'', details, timestamp: Date.now() }; const bases=['tables/','/tables/']; let base='tables/'; for(const b of bases){ try{ const r=await fetch(`${b}audit_logs`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry) }); if(r.ok){ return; } }catch{} } }catch{} }
      function writeJson(obj){ try{ qs('#jsonOut').textContent = JSON.stringify(obj,null,2); }catch{}
      }

      // METRICS list (fallback) used to publish a zeroed snapshot
      const METRICS = (window.METRICS_CATALOG ? (function(){ const list=[]; const seen=new Set(); const AE=window.METRICS_CATALOG.ae||{}; const AM=window.METRICS_CATALOG.am||{}; for(const group of Object.values(AE)){ for(const [k,l] of group){ if(!seen.has(k)){ seen.add(k); list.push([k,l]); } } } for(const group of Object.values(AM)){ for(const [k,l] of group){ if(!seen.has(k)){ seen.add(k); list.push([k,l]); } } } return list; })() : [
        ['callsMade','Calls Made'],['emailsSent','Emails Sent'],['meetingsBooked','Meetings Booked'],['meetingsConducted','Meetings Conducted'],['opportunitiesGenerated','Opportunities Generated'],['pipelineGenerated','Pipeline Generated'],['revenueClosed','Revenue Closed'],['linkedinMessages','LinkedIn Messages'],['vidyardVideos','Vidyard Videos'],['accountsTargeted','Accounts Targeted'],['generalAbmCampaigns','General ABM Campaigns'],['crossSellAbmCampaigns','Cross-Sell ABM Campaigns'],['upSellAbmCampaigns','Up-Sell ABM Campaigns'],['dormantAbmCampaigns','Dormant ABM Campaigns'],['referralsGenerated','Referrals Generated'],['successfulContacts','Successful Contacts']
      ]);

      // Resilient API wrapper
      const API=(function(){
        let BASE='tables/'; const CAND=['tables/','/tables/'];
        function looksHtml(res){ return (res.headers.get('content-type')||'').toLowerCase().includes('text/html'); }
        async function resolveBase(){ for(const b of CAND){ try{ const r=await fetch(`${b}users?limit=1`,{cache:'no-store',credentials:'same-origin'}); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(r.ok && ct.includes('application/json')){ BASE=b; break; } }catch{} } qs('#apiMode').textContent = (BASE==='tables/'?'tables/':'/tables/'); }
        function fetchWithTimeout(url, options={}, timeoutMs=12000){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs); const opts={ ...options, signal: ctrl.signal, cache:'no-store', credentials:'same-origin' }; return fetch(url, opts).finally(()=> clearTimeout(t)); }
        function npath(p){ if(/^https?:/i.test(p)) return p; if(p.startsWith('tables/')) return BASE + p.slice(7); if(p.startsWith('/tables/')) return BASE + p.slice(8); return BASE + p; }
        async function req(method, path, body, tries=5){ await resolveBase(); let last=''; for(let i=0;i<tries;i++){ try{ let url=npath(path); url += (url.includes('?')?'&':'?')+`cb=${Date.now()}_${i}`; const r=await fetchWithTimeout(url,{ method, headers:{'Content-Type':'application/json'}, body: body!=null?JSON.stringify(body):undefined }, 15000); const ct=(r.headers.get('content-type')||'').toLowerCase(); if(!r.ok || looksHtml(r) || (r.status!==204 && !ct.includes('application/json'))){ try{ const wu=npath('tables/users?limit=1'); const sep=wu.includes('?')?'&':'?'; await fetchWithTimeout(`${wu}${sep}cb=${Date.now()}`,{method:'GET'},8000); }catch{} const jitter=Math.floor(Math.random()*250); await new Promise(rz=>setTimeout(rz, 550*Math.pow(1.6,i)+jitter)); continue; } return r; }catch(e){ last=String(e?.message||e); const jitter=Math.floor(Math.random()*250); await new Promise(rz=>setTimeout(rz, 550*Math.pow(1.6,i)+jitter)); } } throw new Error('API blocked '+last); }
        async function json(method, path, body, tries=3){ const r=await req(method,path,body,tries); if (r.status===204) return {}; try{ return await r.json(); }catch{ return {}; } }
        return { json, npath };
      })();

      function getYM(){ return new Date().toISOString().slice(0,7); }

      // Operations
      async function countTable(table){ try{ const r=await API.json('GET', `tables/${table}?limit=1`); return Number(r.total||0); }catch{ return 0; } }
      async function listAll(table, pageSize=1000){ const out=[]; let page=1; while(true){ const r=await API.json('GET', `tables/${table}?page=${page}&limit=${pageSize}`); const rows=r.data||[]; out.push(...rows); if (rows.length<pageSize) break; page++; } return out; }
      function isSandbox(){ try{ return !!document.getElementById('sandboxChk')?.checked; }catch{ return false; } }
      async function deleteAll(table){ const rows = await listAll(table, 500); if (isSandbox()){ return { table, ok:0, fail:0, total: rows.length, sandbox:true }; } let ok=0, fail=0; for (const row of rows){ try{ await API.json('DELETE', `tables/${table}/${encodeURIComponent(row.id)}`); ok++; }catch{ fail++; } } return { table, ok, fail, total: rows.length } }
      function zeroSnapshotPayload(){ const vals={}; for(const [k,l] of METRICS){ vals[k] = { ae:0, am:0 }; } return { month:getYM(), weeks:4, values: vals, userId:null, updated_at: Date.now() }; }

function clearGoalCaches(){ try{ const keys=[]; for (let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if (!k) continue; if (k.startsWith('goals_snapshot_') || k.startsWith('goals_cache_role_') || k==='goals_cache'){ keys.push(k); } } keys.forEach(k=> localStorage.removeItem(k)); }catch{} }
      async function publishZeroSnapshot(){ if (isSandbox()) return { ok:true, id:null, sandbox:true }; try{ const res = await API.json('POST', 'tables/goals_snapshots', zeroSnapshotPayload()); return { ok:true, id: res?.id||null }; }catch(e){ return { ok:false, error:String(e?.message||e) }; } }

      function broadcast(type){ try{ localStorage.setItem(type==='activities'?'ascm_activities_updated':'ascm_goals_updated', String(now())); }catch{} try{ if(!window._ascmChan) window._ascmChan=new BroadcastChannel('ascm_sync'); window._ascmChan.postMessage({ type: type==='activities'?'activities_reset':'goals_updated', at: now() }); }catch{} }

      async function dryRun(){ const act=await countTable('activities'); const goals=await countTable('goals'); const snaps=await countTable('goals_snapshots'); const out={ action:'dry_run', totals:{ activities: act, goals, goals_snapshots: snaps } }; writeJson(out); showRibbon('Dry run complete','success'); showToast('Dry run complete','success'); qs('#progress').textContent = `Activities: ${act.toLocaleString()} · Goals: ${goals.toLocaleString()} · Snapshots: ${snaps.toLocaleString()}`; }
      async function resetActivities(){ qs('#progress').textContent='Deleting activities…'; const r=await deleteAll('activities'); const out={ action:'reset_activities', result:r, sandbox:isSandbox() }; writeJson(out); showRibbon(isSandbox()?'Sandbox: activities reset simulated':'Activities reset complete', 'success'); showToast(isSandbox()?'Sandbox: activities reset simulated':'Activities reset complete','success'); qs('#progress').textContent=`Activities ${isSandbox()?'to be ':''}deleted: ${r.ok}/${r.total}`; if (!isSandbox()) broadcast('activities'); }
      async function resetGoals(){ qs('#progress').textContent='Deleting goals and snapshots…'; const r1=await deleteAll('goals'); const r2=await deleteAll('goals_snapshots'); clearGoalCaches(); const pub=await publishZeroSnapshot(); clearGoalCaches(); const out={ action:'reset_goals', results:{ goals:r1, goals_snapshots:r2, publish_zero: pub }, sandbox:isSandbox() }; writeJson(out); const msg = isSandbox() ? 'Sandbox: goals reset simulated' : 'Goals reset complete (zeroed snapshot published)'; showRibbon(msg,'success'); showToast(msg,'success'); qs('#progress').textContent=`Goals ${isSandbox()?'to be ':''}deleted: ${r1.ok}/${r1.total} · Snapshots ${isSandbox()?'to be ':''}deleted: ${r2.ok}/${r2.total} · Publish zero: ${pub.ok?'OK':'FAIL'}`; if (!isSandbox()){ try{ localStorage.setItem('ascm_goals_updated', String(now())); }catch{} try{ if(!window._ascmChan) window._ascmChan=new BroadcastChannel('ascm_sync'); window._ascmChan.postMessage({ type:'goals_reset', at: now() }); }catch{} broadcast('goals'); } }
      async function masterReset(){ qs('#progress').textContent='Starting master reset…'; await resetActivities(); await resetGoals(); const msg = isSandbox() ? 'Sandbox: Master Reset simulated' : 'Master Reset complete'; showRibbon(msg,'success'); showToast(msg,'success'); }

      // Wire UI
      document.addEventListener('DOMContentLoaded', ()=>{
        const chk=qs('#confirmChk'); const toggleBtns=()=>{ const dis= !chk.checked; ['#btnDryRun','#btnResetActivities','#btnResetGoals','#btnMasterReset'].forEach(id=>{ const b=qs(id); if (b) b.disabled=dis; }); }; if (chk){ chk.addEventListener('change', toggleBtns); toggleBtns(); }
        qs('#btnDryRun').addEventListener('click', dryRun);
        qs('#btnResetActivities').addEventListener('click', ()=>{ const h=openConfirm('activities'); if(!h) return; h.doBtn.onclick = async ()=>{ h.close(); await resetActivities(); await logAudit('reset_activities', { at: Date.now() }); }; });
        qs('#btnResetGoals').addEventListener('click', ()=>{ const h=openConfirm('goals'); if(!h) return; h.doBtn.onclick = async ()=>{ h.close(); await resetGoals(); await logAudit('reset_goals', { at: Date.now() }); }; });
        qs('#btnMasterReset').addEventListener('click', ()=>{ const h=openConfirm('master'); if(!h) return; h.doBtn.onclick = async ()=>{ h.close(); await masterReset(); await logAudit('master_reset', { at: Date.now() }); }; });
      });
    })();
  </script>
</body>
</html>
