<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AE Activity Entry — ASCM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@500;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="ascm/css/theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    :root {
      --group-1: #E6FFFB; /* teal-50-ish */
      --group-2: #EEF2FF; /* indigo-50 */
      --group-3: #ECFEFF; /* cyan-50 */
    }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .headline { font-family: 'Poppins', 'Inter', sans-serif; letter-spacing: .2px; }
    .group-card { background: #fff; border: 1px solid #E5E7EB; border-radius: 16px; padding: 20px; box-shadow: 0 10px 24px rgba(0,0,0,.06); }
    .bg-group-1 { background: var(--group-1); }
    .bg-group-2 { background: var(--group-2); }
    .bg-group-3 { background: var(--group-3); }
    .summary {
      background: linear-gradient(135deg, var(--ascm-green-medium), var(--ascm-blue-accent));
      color: #fff;
      border-radius: 14px; padding: 16px; box-shadow: 0 12px 28px rgba(0,0,0,.08);
    }
    label .help { color: #64748B; margin-left: 6px; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="brand-gradient text-white">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-white/10 grid place-items-center"><i class="fa-solid fa-pen-to-square text-white"></i></div>
        <div>
          <h1 class="text-base font-bold headline">Activity Entry — Account Executive</h1>
          <p class="text-xs text-white/80">Enter your weekly sales activities</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a id="home-button" href="app.html" class="btn-outline px-3 py-2 rounded-md text-sm">Home</a>
        <button id="logout" class="btn-primary px-3 py-2 rounded-md text-sm"><i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-6">
    <div class="flex flex-col md:flex-row md:items-center gap-4 mb-6">
      <div class="flex-1">
        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 headline">Welcome, <span id="userName">User</span></h2>
        <p class="text-sm text-slate-600">Select a week and enter your activity metrics. Use Add to Totals to post to this week.</p>
      </div>
      <div class="flex items-center gap-3">
        <label for="week" class="text-sm text-slate-700">Week</label>
        <select id="week" class="input rounded-md px-3 py-2"></select>
        <button id="resetWeek" class="btn-outline rounded-md px-3 py-2 text-sm"><i class="fa-solid fa-rotate-left mr-2"></i>Reset Week</button>

      </div>
    </div>

    <section class="summary mb-6">
      <div class="grid sm:grid-cols-3 gap-4 text-sm">
        <div>
          <div class="opacity-90">Total Results</div>
          <div class="text-3xl md:text-4xl font-extrabold transition-all duration-300" id="sumResults">0</div>
        </div>
        <div>
          <div class="opacity-90">Pipeline Value</div>
          <div class="text-3xl md:text-4xl font-extrabold transition-all duration-300" id="sumPipeline">$0</div>
        </div>
        <div>
          <div class="opacity-90">Revenue Closed</div>
          <div class="text-3xl md:text-4xl font-extrabold transition-all duration-300" id="sumRevenue">$0</div>
        </div>
      </div>
    </section>

    <form id="form" class="space-y-6">
      <!-- Sales Activities -->
      <div class="group-card">
        <h3 class="font-semibold mb-3">Sales Activities</h3>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700" title="Number of outbound calls placed this week"><i class="fa-solid fa-phone mr-2 text-emerald-600"></i>Calls Made</label>
            <input type="number" min="0" id="callsMade" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700" title="Number of individual sales emails sent"><i class="fa-solid fa-envelope mr-2 text-blue-600"></i>Emails Sent</label>
            <input type="number" min="0" id="emailsSent" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700" title="Number of direct LinkedIn messages sent"><i class="fa-brands fa-linkedin mr-2 text-sky-600"></i>LinkedIn Messages</label>
            <input type="number" min="0" id="linkedinMessages" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700" title="Number of Vidyard (or similar) personalized videos sent"><i class="fa-solid fa-video mr-2 text-lime-600"></i>Vidyard Videos Sent</label>
            <input type="number" min="0" id="vidyardVideos" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-bullhorn mr-2 text-fuchsia-600"></i>ABM Campaigns Launched</label>
            <input type="number" min="0" id="abmCampaigns" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
        </div>
      </div>

      <!-- Sales Results -->
      <div class="group-card bg-group-1">
        <h3 class="font-semibold mb-3">Sales Results</h3>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-calendar-check mr-2 text-violet-600"></i>Meetings Booked</label>
            <input type="number" min="0" id="meetingsBooked" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-circle-check mr-2 text-emerald-600"></i>Successful Contacts</label>
            <input type="number" min="0" id="successfulContacts" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-person-chalkboard mr-2 text-amber-600"></i>Meetings Conducted</label>
            <input type="number" min="0" id="meetingsConducted" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-lightbulb mr-2 text-yellow-500"></i>Opportunities Generated</label>
            <input type="number" min="0" id="opportunitiesGenerated" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-share-nodes mr-2 text-cyan-600"></i>Referrals Generated</label>
            <input type="number" min="0" id="referralsGenerated" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
        </div>
      </div>

      <!-- Financial Performance -->
      <div class="group-card bg-group-2">
        <h3 class="font-semibold mb-3">Financial Performance</h3>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-funnel-dollar mr-2 text-indigo-600"></i>Pipeline Generated ($)</label>
            <input type="number" min="0" step="100" id="pipelineGenerated" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700"><i class="fa-solid fa-sack-dollar mr-2 text-green-700"></i>Revenue Closed ($)</label>
            <input type="number" min="0" step="100" id="revenueClosed" class="input w-full rounded-md px-3 py-2" value="0">
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <button type="button" id="saveDraft" class="btn-outline rounded-md px-4 py-2"><i class="fa-solid fa-save mr-2"></i>Save Draft</button>
        <div class="flex gap-2">
          <button type="button" id="addTotals" class="btn-accent rounded-md px-4 py-2"><i class="fa-solid fa-plus mr-2"></i>Update Week's Total</button>
          <button type="button" id="undoLast" class="btn-outline rounded-md px-4 py-2" disabled><i class="fa-solid fa-rotate-left mr-2"></i>Undo Last Entry</button>
          <button type="button" id="submit" class="btn-primary rounded-md px-4 py-2"><i class="fa-solid fa-paper-plane mr-2"></i>Submit</button>
        </div>
      </div>
    </form>

    <div class="mt-8">
      <h3 class="font-semibold mb-2">This Week’s Entries</h3>
      <div id="entries" class="grid gap-2"></div>
    </div>
  </main>

  <script type="module">
    import { requireAuthOrRedirect, currentWeekId, weeksWithLabels, listUserWeekActivities, createActivity, deleteRecord, sanitizeNumber, sumMetrics, toast, showInlineBadgeAtId, showInlineBadgeAtTop, getImpersonation, startImpersonation, stopImpersonation, loadUsersSimple } from './js/activity-utils.js';
    const session = requireAuthOrRedirect();
    // Enforce role-based access: AE page is restricted to AE or Admin
    const role = String(session?.role||'').toLowerCase();
    const isAdmin = role==='admin';
    if (!isAdmin && role!=='ae') { window.location.replace('activity-entry-router.html'); }

    // UI refs
    const userName = document.getElementById('userName');
    const header = document.querySelector('header .max-w-6xl');
    const weekSel = document.getElementById('week');
    const sumResults = document.getElementById('sumResults');
    const sumPipeline = document.getElementById('sumPipeline');
    const sumRevenue = document.getElementById('sumRevenue');
    const entries = document.getElementById('entries');

    const fields = ['callsMade','emailsSent','linkedinMessages','vidyardVideos','abmCampaigns','meetingsBooked','successfulContacts','meetingsConducted','opportunitiesGenerated','referralsGenerated','pipelineGenerated','revenueClosed']; let _lastCreatedId=null;

    userName.textContent = session.name || session.email;

    // Admin impersonation banner
    let impersonation = getImpersonation();
    if (isAdmin) {
      const bar = document.createElement('div');
      bar.id = 'impersonationBar';
      bar.className = 'w-full flex items-center gap-2 mt-2';
      bar.innerHTML = `
        <div class="px-2 py-1 rounded border text-xs ${impersonation? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-slate-100 border-slate-200 text-slate-700'}">
          ${impersonation? `<i class='fa-solid fa-user-secret mr-1'></i>Impersonating: <strong>${impersonation.name||impersonation.email||impersonation.id}</strong> (${impersonation.role?.toUpperCase()||''})` : 'Impersonate user:'}
        </div>
        <select id="impersonateSelect" class="input rounded-md px-2 py-1 text-xs min-w-[220px]"></select>
        <button id="impersonateStart" class="btn-outline rounded-md px-2 py-1 text-xs">Start</button>
        <button id="impersonateStop" class="btn-accent rounded-md px-2 py-1 text-xs ${impersonation? '' : 'hidden'}">Stop</button>
      `;
      header.appendChild(bar);
      const sel = bar.querySelector('#impersonateSelect');
      loadUsersSimple(1000).then(users=>{
        sel.innerHTML = users.map(u=>`<option value="${u.id}">${u.name||u.email||u.id}</option>`).join('');
        if (impersonation) sel.value = impersonation.id;
      });
      bar.querySelector('#impersonateStart').addEventListener('click', async ()=>{
        const id = sel.value;
        const users = await loadUsersSimple(1000);
        const u = users.find(x=> x.id===id);
        if (!u) { toast('Select a user to impersonate','error'); return; }
        try { impersonation = await startImpersonation(u); toast('Impersonation active for '+(impersonation.name||impersonation.email)); bar.querySelector('#impersonateStop').classList.remove('hidden'); bar.querySelector('div').className='px-2 py-1 rounded border text-xs bg-amber-50 border-amber-200 text-amber-700'; bar.querySelector('div').innerHTML = `<i class='fa-solid fa-user-secret mr-1'></i>Impersonating: <strong>${impersonation.name||impersonation.email||impersonation.id}</strong> (${impersonation.role?.toUpperCase()||''})`; } catch(e){ toast('Failed to start impersonation','error'); }
      });
      bar.querySelector('#impersonateStop').addEventListener('click', async ()=>{
        try { await stopImpersonation(); impersonation=null; toast('Stopped impersonating'); bar.querySelector('#impersonateStop').classList.add('hidden'); bar.querySelector('div').className='px-2 py-1 rounded border text-xs bg-slate-100 border-slate-200 text-slate-700'; bar.querySelector('div').textContent='Impersonate user:'; } catch(e){ toast('Failed to stop impersonation','error'); }
      });
    }

    // Populate weeks
    const weeks = weeksWithLabels(16);
    weeks.forEach(w => { const opt = document.createElement('option'); opt.value = w.id; opt.textContent = w.label; weekSel.appendChild(opt); });
    weekSel.value = currentWeekId();

    // Role switching is removed; admins use impersonation instead

    document.getElementById('logout').addEventListener('click', () => { localStorage.removeItem('ascm_session'); window.location.assign('index.html'); });

    document.getElementById('resetWeek').addEventListener('click', async () => {
      if (!confirm('Reset all your data for the selected week? This will delete records for that week.')) return;
      const items = await listUserWeekActivities(session.id, weekSel.value);
      for (const r of items) { try { await deleteRecord(r.id); } catch(e) { console.warn('Delete failed', r.id, e); } }
      try { localStorage.setItem('ascm_week_reset', String(Date.now())); } catch {}
      await refresh();
    });

    function readValues() {
      const data = {};
      for (const f of fields) data[f] = sanitizeNumber(document.getElementById(f).value);
      return data;
    }

    function animateNumber(el, start, end, duration=350, prefix='', format=val => val){
      const t0 = performance.now();
      function step(ts){
        const p = Math.min(1, (ts - t0) / duration);
        const val = Math.round(start + (end - start) * p);
        el.textContent = prefix + format(val);
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function liveSummary(records) {
      const keysResults = ['meetingsBooked','successfulContacts','meetingsConducted','opportunitiesGenerated','referralsGenerated'];
      const totals = sumMetrics(records, [...fields]);
      const totalResults = keysResults.reduce((s,k)=>s+totals[k],0);
      const currentResults = parseInt(sumResults.textContent.replace(/[^0-9]/g,'')) || 0;
      const currentPipeline = parseInt(String(sumPipeline.textContent).replace(/[^0-9]/g,'')) || 0;
      const currentRevenue = parseInt(String(sumRevenue.textContent).replace(/[^0-9]/g,'')) || 0;
      animateNumber(sumResults, currentResults, totalResults, 350);
      animateNumber(sumPipeline, currentPipeline, totals.pipelineGenerated||0, 350, '$', (v)=> v.toLocaleString());
      animateNumber(sumRevenue, currentRevenue, totals.revenueClosed||0, 350, '$', (v)=> v.toLocaleString());
    }

    function persistDraft(){ localStorage.setItem(`ae_draft_${session.id}_${weekSel.value}`, JSON.stringify(readValues())); }
    function loadDraft(){
      try {
        const raw = localStorage.getItem(`ae_draft_${session.id}_${weekSel.value}`);
        if (!raw) return;
        const d = JSON.parse(raw);
        for (const f of fields) if (d[f] !== undefined) document.getElementById(f).value = d[f];
      } catch {}
    }

    async function refresh(){
      const items = await listUserWeekActivities(session.id, weekSel.value);
      // render entries
      if (!items.length) {
        entries.innerHTML = '<div class="text-sm text-slate-500">No entries yet this week.</div>';
      } else {
        entries.innerHTML = items.map(r => {
          const when = new Date(r.createdAt||r.date||Date.now());
          const parts = [];
          if (r.callsMade>0) parts.push(`${r.callsMade} calls`);
          if (r.emailsSent>0) parts.push(`${r.emailsSent} emails`);
          if (r.meetingsBooked>0) parts.push(`${r.meetingsBooked} mtgs`);
          if (r.opportunitiesGenerated>0) parts.push(`${r.opportunitiesGenerated} opps`);
          if (r.pipelineGenerated>0) parts.push(`$${Number(r.pipelineGenerated).toLocaleString()} pipeline`);
          if (r.revenueClosed>0) parts.push(`$${Number(r.revenueClosed).toLocaleString()} revenue`);
          const line = parts.join(' · ') || '—';
          return `<div class=\"card rounded-md p-3 flex items-center justify-between\"><div><div class=\"font-medium\">${when.toLocaleDateString()} ${when.toLocaleTimeString()}</div><div class=\"text-sm text-slate-600\">${line}</div></div><button data-id=\"${r.id}\" class=\"btn-outline px-3 py-1 rounded-md text-xs\">Delete</button></div>`;
        }).join('');
        entries.querySelectorAll('button[data-id]').forEach(btn => btn.addEventListener('click', async (e) => { const id = e.currentTarget.dataset.id; if (confirm('Delete this entry?')) { await deleteRecord(id); await refresh(); }}));
      }
      liveSummary(items);
    }

    // Events
    weekSel.addEventListener('change', () => { loadDraft(); refresh(); });
    document.getElementById('saveDraft').addEventListener('click', () => { persistDraft(); toast('Draft saved'); });
    function updateUndoState(){ const btn=document.getElementById('undoLast'); try { const id=localStorage.getItem('ae_last_entry_id'); if (btn) { btn.disabled = !id; btn.classList.toggle('opacity-60', !id); btn.title = id? 'Delete the last entry you created' : 'No recent entry to undo'; } } catch{} }

    document.getElementById('addTotals').addEventListener('click', async () => {
      const debug = location.search.includes('debug=1');
      const values = readValues();
      const payload = { ...values, role:'ae', userId: session.id, userName: session.name||session.email, week: weekSel.value, date: Date.now(), createdAt: Date.now() };
      try{
        const res = await createActivity(payload);
        if (res && res.id) { _lastCreatedId = res.id; try { localStorage.setItem('ae_last_entry_id', res.id); } catch {} }
        await refresh();
        updateUndoState();
        toast("Week's totals updated");
        try { if (_lastCreatedId) showInlineBadgeAtId('entries', _lastCreatedId, 'Saved'); else showInlineBadgeAtTop('entries','Saved'); } catch{}
        if (debug) console.log('[AE][addTotals] saved', res);
      } catch(e){
        console.warn('[AE][addTotals] save failed', e);
        toast('Could not update totals', 'error');
      }
    });
    document.getElementById('undoLast').addEventListener('click', async ()=>{ try { const id = localStorage.getItem('ae_last_entry_id'); if (!id) return; await deleteRecord(id); localStorage.removeItem('ae_last_entry_id'); await refresh(); updateUndoState(); toast('Undid last entry'); showInlineBadgeAtTop('entries','Saved'); } catch(e){ console.warn('Undo failed', e); toast('Undo failed','error'); } });

    document.getElementById('submit').addEventListener('click', async () => {
      const debug = location.search.includes('debug=1');
      const values = readValues();
      const payload = { ...values, role:'ae', userId: session.id, userName: session.name||session.email, week: weekSel.value, date: Date.now(), createdAt: Date.now() };
      try{
        const res = await createActivity(payload);
        localStorage.removeItem(`ae_draft_${session.id}_${weekSel.value}`);
        // Clear inputs
        for (const f of fields) document.getElementById(f).value = 0;
        if (res && res.id) { _lastCreatedId = res.id; try { localStorage.setItem('ae_last_entry_id', res.id); } catch {} }
        await refresh();
        updateUndoState();
        toast('Activity submitted');
        try { if (_lastCreatedId) showInlineBadgeAtId('entries', _lastCreatedId, 'Saved'); else showInlineBadgeAtTop('entries','Saved'); } catch{}
        if (debug) console.log('[AE][submit] saved', res);
      } catch(e){
        console.warn('[AE][submit] save failed', e);
        toast('Could not submit activity','error');
      }
    });

    // Live summary updates with current inputs overlay
    document.getElementById('form').addEventListener('input', async () => {
      // Auto-save draft while typing
      try{ localStorage.setItem(`ae_draft_${session.id}_${weekSel.value}`, JSON.stringify(readValues())); }catch{}
      // Live recompute totals (overlay current inputs)
      try{
        const items = await listUserWeekActivities(session.id, weekSel.value);
        const cur = readValues();
        items.push(cur);
        liveSummary(items);
      }catch(e){ /* ignore for live preview */ }
    });

    // init
    loadDraft();
    refresh();
    updateUndoState();
  </script>
</body>
</html>
